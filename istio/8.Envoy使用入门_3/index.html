<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Envoy使用入门_3 | CloudNativeNotes</title>
    <meta name="description" content="Vuepress blog demo">
    
    
    <link rel="preload" href="/CloudNativeNotes/assets/css/0.styles.7bebe62c.css" as="style"><link rel="preload" href="/CloudNativeNotes/assets/js/app.c1070463.js" as="script"><link rel="preload" href="/CloudNativeNotes/assets/js/2.6ea23a4f.js" as="script"><link rel="preload" href="/CloudNativeNotes/assets/js/50.f9be5e46.js" as="script"><link rel="prefetch" href="/CloudNativeNotes/assets/js/10.f683548e.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/11.9b2223ea.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/12.3d0adbb0.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/13.24d3d2d6.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/14.fb7baf12.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/15.eb690184.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/16.6733f10e.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/17.5cea8e35.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/18.72d80979.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/19.1d75c5a7.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/20.5d1c5bdc.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/21.0d03d3c8.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/22.781cc661.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/23.da24d4a5.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/24.64806e3e.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/25.f48de550.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/26.e94508f2.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/27.13277697.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/28.daef1e27.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/29.6a2b975d.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/3.a99930e0.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/30.10d3ea34.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/31.9fb204ed.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/32.0b73c47c.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/33.e496dee3.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/34.9afa7698.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/35.1af9afd5.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/36.647a0f69.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/37.73629427.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/38.147eec58.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/39.a011e2e7.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/4.3ff2fe10.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/40.f5d50c60.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/41.12a538ad.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/42.bc7be63b.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/43.509cb678.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/44.f3cbf9dd.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/45.0c6478d7.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/46.122aa56e.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/47.78053982.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/48.abeefd62.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/49.b2619eaf.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/5.d3507002.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/51.70801648.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/52.3ddd65d3.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/53.968a532f.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/6.a9535db6.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/7.b77fe9cf.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/8.2c03d1fa.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/9.836f7399.js">
    <link rel="stylesheet" href="/CloudNativeNotes/assets/css/0.styles.7bebe62c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/CloudNativeNotes/" class="home-link router-link-active"><!----> <span class="site-name">CloudNativeNotes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/CloudNativeNotes/" class="nav-link">Home</a></div><div class="nav-item"><a href="/CloudNativeNotes/Docker/1.Dockerfile使用总结/" class="nav-link">Docker</a></div><div class="nav-item"><a href="/CloudNativeNotes/Kubernetes/1.Kubernetes基础/" class="nav-link">Kubernetes</a></div><div class="nav-item"><a href="/CloudNativeNotes/istio/1.Service Mesh简介/" class="nav-link">Istio</a></div><div class="nav-item"><a href="/CloudNativeNotes/Ceph/1.简介/" class="nav-link">Ceph</a></div><div class="nav-item"><a href="/CloudNativeNotes/Prometheus/" class="nav-link">Prometheus</a></div> <a href="https://github.com/Aaron1989/CloudNativeNotes" target="_blank" rel="noopener noreferrer" class="repo-link">
    My GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/CloudNativeNotes/" class="nav-link">Home</a></div><div class="nav-item"><a href="/CloudNativeNotes/Docker/1.Dockerfile使用总结/" class="nav-link">Docker</a></div><div class="nav-item"><a href="/CloudNativeNotes/Kubernetes/1.Kubernetes基础/" class="nav-link">Kubernetes</a></div><div class="nav-item"><a href="/CloudNativeNotes/istio/1.Service Mesh简介/" class="nav-link">Istio</a></div><div class="nav-item"><a href="/CloudNativeNotes/Ceph/1.简介/" class="nav-link">Ceph</a></div><div class="nav-item"><a href="/CloudNativeNotes/Prometheus/" class="nav-link">Prometheus</a></div> <a href="https://github.com/Aaron1989/CloudNativeNotes" target="_blank" rel="noopener noreferrer" class="repo-link">
    My GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>写在最前面</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CloudNativeNotes/start/1.%E9%98%85%E8%AF%BB%E6%8C%87%E5%BC%95/" class="sidebar-link">写在最前面</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Docker篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CloudNativeNotes/Docker/1.Dockerfile%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/" class="sidebar-link">Dockerfile使用总结</a></li><li><a href="/CloudNativeNotes/Docker/2.%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93%E5%92%8C%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6/" class="sidebar-link">私有仓库和资源限制</a></li><li><a href="/CloudNativeNotes/Docker/3.Docker%20Compose%E5%9F%BA%E7%A1%80%E5%BA%94%E7%94%A8/" class="sidebar-link">Docker Compose基础应用</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Kubernetes篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CloudNativeNotes/Kubernetes/1.Kubernetes%E5%9F%BA%E7%A1%80/" class="sidebar-link">Kubernetes基础</a></li><li><a href="/CloudNativeNotes/Kubernetes/2.Kubernetes%E5%9F%BA%E7%A1%80%E5%92%8C%E9%83%A8%E7%BD%B2%E8%AF%B4%E6%98%8E/" class="sidebar-link">Kubernetes基础和部署说明</a></li><li><a href="/CloudNativeNotes/Kubernetes/3.%E4%BD%BF%E7%94%A8Kubeadm%E9%83%A8%E7%BD%B2k8s%E9%9B%86%E7%BE%A4/" class="sidebar-link">使用Kubeadm部署k8s集群</a></li><li><a href="/CloudNativeNotes/Kubernetes/4.Kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" class="sidebar-link">Kubernetes快速入门</a></li><li><a href="/CloudNativeNotes/Kubernetes/5.Pod%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E9%85%8D%E7%BD%AE%E5%9F%BA%E7%A1%80/" class="sidebar-link">Pod资源清单配置基础</a></li><li><a href="/CloudNativeNotes/Kubernetes/6.Pod%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/" class="sidebar-link">Pod资源管理</a></li><li><a href="/CloudNativeNotes/Kubernetes/7.Pod%E6%8E%A7%E5%88%B6%E5%99%A8-Deployment/" class="sidebar-link">Pod控制器-Deployment</a></li><li><a href="/CloudNativeNotes/Kubernetes/8.Pod%E6%8E%A7%E5%88%B6%E5%99%A8-DaemonSet/" class="sidebar-link">Pod控制器-DaemonSet</a></li><li><a href="/CloudNativeNotes/Kubernetes/9.Pod%E6%8E%A7%E5%88%B6%E5%99%A8-Job/" class="sidebar-link">Pod控制器-Job</a></li><li><a href="/CloudNativeNotes/Kubernetes/10.Service%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/" class="sidebar-link">Service资源管理</a></li><li><a href="/CloudNativeNotes/Kubernetes/11.Ingress%E8%B5%84%E6%BA%90/" class="sidebar-link">Ingress资源</a></li><li><a href="/CloudNativeNotes/Kubernetes/12.Volume%E5%9F%BA%E7%A1%80%E5%BA%94%E7%94%A8/" class="sidebar-link">Volume基础应用源</a></li><li><a href="/CloudNativeNotes/Kubernetes/13.ConfigMap%E8%B5%84%E6%BA%90/" class="sidebar-link">ConfigMap资源</a></li><li><a href="/CloudNativeNotes/Kubernetes/14.Secret%E8%B5%84%E6%BA%90/" class="sidebar-link">Secret资源</a></li><li><a href="/CloudNativeNotes/Kubernetes/15.StatefulSet%E8%B5%84%E6%BA%90/" class="sidebar-link">StatefulSet资源</a></li><li><a href="/CloudNativeNotes/Kubernetes/16.Kubernetes%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8/" class="sidebar-link">Kubernetes系统安全</a></li><li><a href="/CloudNativeNotes/Kubernetes/17.Dashboard/" class="sidebar-link">Dashboard</a></li><li><a href="/CloudNativeNotes/Kubernetes/18.%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6%E5%99%A8/" class="sidebar-link">准入控制器</a></li><li><a href="/CloudNativeNotes/Kubernetes/19.%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E4%BD%93%E7%B3%BB/" class="sidebar-link">网络插件体系</a></li><li><a href="/CloudNativeNotes/Kubernetes/20.Network-Policy/" class="sidebar-link">Network-Policy</a></li><li><a href="/CloudNativeNotes/Kubernetes/21.%E8%B0%83%E5%BA%A6%E5%99%A8%E4%B8%8E%E8%B0%83%E5%BA%A6%E6%9C%BA%E5%88%B6/" class="sidebar-link">调度器与调度机制</a></li><li><a href="/CloudNativeNotes/Kubernetes/22.%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6%E6%9C%BA%E5%88%B6/" class="sidebar-link">高级调度机制</a></li><li><a href="/CloudNativeNotes/Kubernetes/23.%E6%B1%A1%E7%82%B9%E5%92%8C%E5%AE%B9%E5%BF%8D%E5%BA%A6/" class="sidebar-link">污点和容忍度</a></li><li><a href="/CloudNativeNotes/Kubernetes/24.%E4%BD%BF%E7%94%A8CRD%E6%89%A9%E5%B1%95Kubernetes-API/" class="sidebar-link">使用CRD扩展Kubernetes-API</a></li><li><a href="/CloudNativeNotes/Kubernetes/25.HPA%E6%8E%A7%E5%88%B6%E5%99%A8/" class="sidebar-link">HPA控制器</a></li><li><a href="/CloudNativeNotes/Kubernetes/26.Helm%E5%9F%BA%E7%A1%80/" class="sidebar-link">Helm基础</a></li><li><a href="/CloudNativeNotes/Kubernetes/27.Helm%E4%BD%BF%E7%94%A8%E8%BF%9B%E9%98%B6/" class="sidebar-link">Helm使用进阶</a></li><li><a href="/CloudNativeNotes/Kubernetes/28.%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2%E9%AB%98%E5%8F%AF%E7%94%A8k8s%E9%9B%86%E7%BE%A4/" class="sidebar-link">二进制部署高可用k8s集群阶</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Istio篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CloudNativeNotes/istio/1.Service%20Mesh%E7%AE%80%E4%BB%8B/" class="sidebar-link">Service Mesh简介</a></li><li><a href="/CloudNativeNotes/istio/2.%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%92%8C%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E5%9F%BA%E7%A1%80/" class="sidebar-link">微服务和服务治理基础</a></li><li><a href="/CloudNativeNotes/istio/3.Envoy%E5%9F%BA%E7%A1%80/" class="sidebar-link">Envoy基础</a></li><li><a href="/CloudNativeNotes/istio/4.Envoy%E9%83%A8%E7%BD%B2%E7%B1%BB%E5%9E%8B/" class="sidebar-link">Envoy部署类型</a></li><li><a href="/CloudNativeNotes/istio/5.Envoy%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F/" class="sidebar-link">Envoy配置方式</a></li><li><a href="/CloudNativeNotes/istio/6.Envoy%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8_1/" class="sidebar-link">Envoy使用入门_1</a></li><li><a href="/CloudNativeNotes/istio/7.Envoy%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8_2/" class="sidebar-link">Envoy使用入门_2</a></li><li><a href="/CloudNativeNotes/istio/8.Envoy%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8_3/" class="active sidebar-link">Envoy使用入门_3</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CloudNativeNotes/istio/8.Envoy%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8_3/#_1-l4过滤器http-connection-manager" class="sidebar-link">1.L4过滤器httpconnectionmanager</a></li><li class="sidebar-sub-header"><a href="/CloudNativeNotes/istio/8.Envoy%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8_3/#_2-egress代理配置示例" class="sidebar-link">2.Egress代理配置示例</a></li><li class="sidebar-sub-header"><a href="/CloudNativeNotes/istio/8.Envoy%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8_3/#_3-egress实战" class="sidebar-link">3.Egress实战</a></li><li class="sidebar-sub-header"><a href="/CloudNativeNotes/istio/8.Envoy%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8_3/#_4-ingress实战" class="sidebar-link">4.Ingress实战</a></li></ul></li><li><a href="/CloudNativeNotes/istio/9.Envoy%E7%AE%A1%E7%90%86%E6%8E%A5%E5%8F%A3%E5%9F%BA%E7%A1%80%E5%BA%94%E7%94%A8/" class="sidebar-link">Envoy管理接口基础应用</a></li><li><a href="/CloudNativeNotes/istio/10.Envoy%E7%BB%BC%E5%90%88%E7%A4%BA%E4%BE%8B_FrontProxy/" class="sidebar-link">Envoy综合示例_FrontProxy</a></li><li><a href="/CloudNativeNotes/istio/11.xDS%20API%E5%8F%8A%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE_1/" class="sidebar-link">xDS API及动态配置_1</a></li><li><a href="/CloudNativeNotes/istio/12.xDS%20API%E5%8F%8A%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE_2/" class="sidebar-link">xDS API及动态配置_2</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Ceph篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CloudNativeNotes/Ceph/1.%E7%AE%80%E4%BB%8B/" class="sidebar-link">综述</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Prometheus篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CloudNativeNotes/Prometheus/" class="sidebar-link">综述</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="envoy使用入门-3"><a href="#envoy使用入门-3" class="header-anchor">#</a> Envoy使用入门_3</h1> <p>本章节首先阐述<code>L4</code>过滤器<code>http_connection_manage</code>r和<code>egress</code>代理配置说明，然后使用2个完善的例子，
让你充分了解<code>http_connection_manager</code>于<code>egress</code>和<code>ingress</code>中的使用情况。</p> <ul><li>L4过滤器http_connection_manager</li> <li>Egress代理配置示例</li> <li>Egress实战</li> <li>Ingress实战</li></ul> <h2 id="_1-l4过滤器http-connection-manager"><a href="#_1-l4过滤器http-connection-manager" class="header-anchor">#</a> 1.L4过滤器http_connection_manager</h2> <p><code>http_connection_manager</code>通过引入<code>L7</code>过滤器链实现了对<code>http</code>协议的操纵， 其中<code>router</code>过滤器用于配置路由转发</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">listeners</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span>
    <span class="token key atrule">address</span><span class="token punctuation">:</span>
      <span class="token key atrule">socket_address</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">address</span><span class="token punctuation">:</span> <span class="token punctuation">...</span><span class="token punctuation">,</span> <span class="token key atrule">port_value</span><span class="token punctuation">:</span> <span class="token punctuation">...</span><span class="token punctuation">,</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> <span class="token punctuation">...</span> <span class="token punctuation">}</span>
    <span class="token key atrule">filter_chains</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">filters</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> envoy.http_connection_manager
        <span class="token key atrule">config</span><span class="token punctuation">:</span>
          <span class="token key atrule">condec_type</span><span class="token punctuation">:</span> <span class="token punctuation">...</span> <span class="token comment"># 连接管理器使用的编解码器类型，可用值有AUTO、HTTP1和HTTP2；</span>
          <span class="token key atrule">stat_prefix</span><span class="token punctuation">:</span> <span class="token punctuation">...</span> <span class="token comment"># 统计信息中使用的易读性的信息前缀；</span>
          <span class="token key atrule">route_config</span><span class="token punctuation">:</span> <span class="token comment"># 静态路由配置；动态配置应该使用rds字段进行指定；</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">...</span> <span class="token comment"># 路由配置的名称；</span>
            <span class="token key atrule">virtual_hosts</span><span class="token punctuation">:</span> <span class="token comment"># 虚拟主机列表，用于构成路由表；</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">...</span> <span class="token comment"># 虚拟主机的逻辑名称，用于统计信息，与路由无关；</span>
              <span class="token key atrule">domains</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment"># 当前虚拟主机匹配的域名列表，支持使用“*”通配符；匹配搜索次序为精确匹配、前缀通配、后缀通配及完全通配；</span>
              <span class="token key atrule">routes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment"># 路由列表，按顺序搜索，第一个匹配到路由信息；</span>
          <span class="token key atrule">http_filters</span><span class="token punctuation">:</span> <span class="token comment"># 定义http过滤器链</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> envoy.router <span class="token comment"># 调用的过滤器为envoy.router</span>
</code></pre></div><p>注意：</p> <ul><li>处理请求时，<code>Envoy</code>首先根据下游客户端请求的<code>host</code>来搜索虚拟主机列表中各<code>virtual_host</code>中的<code>domains</code>列表中的定义，第一个匹配到的<code>Domain</code>的定义所属的<code>virtual_host</code>即可处理请求的虚拟主机；</li> <li>而后搜索当前虚拟主机中的<code>routes</code>列表中的路由列表中各路由条目的<code>match</code>的定义，第一个匹配到的<code>match</code>后的路由机制（<code>route</code>、<code>redirect</code>或<code>direct_response</code>）即生效；</li></ul> <h2 id="_2-egress代理配置示例"><a href="#_2-egress代理配置示例" class="header-anchor">#</a> 2.Egress代理配置示例</h2> <p>下面是一个<code>egress</code>类型的<code>Envoy</code>配置示例，它定义了两个<code>virtual_host</code>，不过，发往第二个<code>virtual_host</code>的请求将被重定向至第一个<code>virtual_hosts：web_service_1</code></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">static_resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">listeners</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> listener_0
      <span class="token key atrule">address</span><span class="token punctuation">:</span>
        <span class="token key atrule">socket_address</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">address</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">,</span> <span class="token key atrule">port_value</span><span class="token punctuation">:</span> <span class="token number">80 </span><span class="token punctuation">}</span>
      <span class="token key atrule">filter_chains</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">filters</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> envoy.http_connection_manager
          <span class="token key atrule">config</span><span class="token punctuation">:</span>
            <span class="token key atrule">stat_prefix</span><span class="token punctuation">:</span> egress_http
            <span class="token key atrule">codec_type</span><span class="token punctuation">:</span> AUTO
            <span class="token key atrule">route_config</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> test_route
              <span class="token key atrule">virtual_hosts</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web_service_1
                <span class="token key atrule">domains</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;*.ik8s.io&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ik8s.io&quot;</span><span class="token punctuation">]</span>
                <span class="token key atrule">routes</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">prefix</span><span class="token punctuation">:</span> <span class="token string">&quot;/&quot;</span> <span class="token punctuation">}</span>
                  <span class="token key atrule">route</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">cluster</span><span class="token punctuation">:</span> web_cluster_1 <span class="token punctuation">}</span>
              <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web_service_2
                <span class="token key atrule">domains</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;*.k8scast.cn&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;k8scast.cn&quot;</span><span class="token punctuation">]</span>
                <span class="token key atrule">routes</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">prefix</span><span class="token punctuation">:</span> <span class="token string">&quot;/&quot;</span> <span class="token punctuation">}</span>
                  <span class="token key atrule">redirect</span><span class="token punctuation">:</span>
                    <span class="token key atrule">host_redirect</span><span class="token punctuation">:</span> <span class="token string">&quot;www.ik8s.io&quot;</span>
            <span class="token key atrule">http_filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> envoy.router
    <span class="token key atrule">clusters</span><span class="token punctuation">:</span>
      <span class="token punctuation">...</span>
</code></pre></div><h2 id="_3-egress实战"><a href="#_3-egress实战" class="header-anchor">#</a> 3.Egress实战</h2> <p>需要提前配置好<code>ip_forward</code>：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>sysctl -w net.ipv4.ip_forward<span class="token operator">=</span><span class="token number">1</span>
</code></pre></div><p><img src="https://github-aaron89.oss-cn-beijing.aliyuncs.com/istio/egress-http_connection_manager.png" alt="egress-1"></p> <p>你需要先读懂这张图，本小结准备用<code>curl</code>模拟<code>Sidecar</code>模式下<code>egress</code>的工作逻辑，并借用内建的<code>filter(http_connection_manager)</code>进行代理。</p> <ol><li><p>将<code>egress</code>目录下的配置文件拉取到本地，并使用<code>docker-compose up</code>。
所有需要注意的地方，已经在配置文件中进行了注释</p></li> <li><p>注意业务容器<code>ID</code>，下面测试会<code>echo</code>出来，用于检测。
进入<code>egress_envoy_1</code>容器的交互式接口，准备测试</p></li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>CONTAINER ID        IMAGE                               COMMAND                  CREATED             STATUS              PORTS               NAMES
2771ccb25e01        egress_envoy                        <span class="token string">&quot;/docker-entrypoint.…&quot;</span>   <span class="token number">22</span> seconds ago      Up <span class="token number">21</span> seconds       <span class="token number">10000</span>/tcp           egress_envoy_1
bdd457740567        ikubernetes/mini-http-server:v0.3   <span class="token string">&quot;/bin/httpserver&quot;</span>        <span class="token number">24</span> seconds ago      Up <span class="token number">23</span> seconds       <span class="token number">8081</span>/tcp            egress_webserver1_1
a9273da1f539        ikubernetes/mini-http-server:v0.3   <span class="token string">&quot;/bin/httpserver&quot;</span>        <span class="token number">24</span> seconds ago      Up <span class="token number">23</span> seconds       <span class="token number">8081</span>/tcp            egress_webserver2_1
    
    
<span class="token punctuation">[</span>root@k8s-etcd-mater01 tcpproxy<span class="token punctuation">]</span><span class="token comment"># docker exec -it egress_envoy_1 /bin/sh</span>
/ <span class="token comment"># ifconfig </span>
eth0      Link encap:Ethernet  HWaddr 02:42:AC:13:00:04  
          inet addr:172.19.0.4  Bcast:172.19.255.255  Mask:255.255.0.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:17 errors:0 dropped:0 overruns:0 frame:0
          TX packets:21 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:1794 <span class="token punctuation">(</span><span class="token number">1.7</span> KiB<span class="token punctuation">)</span>  TX bytes:1554 <span class="token punctuation">(</span><span class="token number">1.5</span> KiB<span class="token punctuation">)</span>
    
lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:15 errors:0 dropped:0 overruns:0 frame:0
          TX packets:15 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:898 <span class="token punctuation">(</span><span class="token number">898.0</span> B<span class="token punctuation">)</span>  TX bytes:898 <span class="token punctuation">(</span><span class="token number">898.0</span> B<span class="token punctuation">)</span>
    
/ <span class="token comment"># netstat -tnlp</span>
Active Internet connections <span class="token punctuation">(</span>only servers<span class="token punctuation">)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.11:42955        <span class="token number">0.0</span>.0.0:*               LISTEN      -
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:80            <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">1</span>/envoy

</code></pre></div><ol start="3"><li>根据我们的预研，分别进行<code>curl</code>测试，发现跳转结果和预期一样，配置成功</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>/ <span class="token comment"># curl -H &quot;host: www.ik8s.io&quot; 127.0.0.1/hostname</span>
Hostname: bdd457740567.              <span class="token comment">#webserver1</span>
    
/ <span class="token comment"># curl -H &quot;host: www.k8scast.cn&quot; 127.0.0.1/hostname</span>
Hostname: a9273da1f539.              <span class="token comment">#webserver2</span>
    
/ <span class="token comment"># curl -H &quot;host: www.k8sall.cn&quot; 127.0.0.1/hostname</span>
Hostname: bdd457740567.             <span class="token comment">#webserver1</span>
/ <span class="token comment"># curl -H &quot;host: www.k8sall.cn&quot; 127.0.0.1/hostname</span>
Hostname: a9273da1f539.             <span class="token comment">#webserver2</span>
    
<span class="token function">curl</span> -H <span class="token string">&quot;host: www.k8stest.com&quot;</span> <span class="token number">127.0</span>.0.1/hostname
Hostname: bdd457740567.            <span class="token comment">#webserver1</span>

</code></pre></div><h2 id="_4-ingress实战"><a href="#_4-ingress实战" class="header-anchor">#</a> 4.Ingress实战</h2> <ol><li>所有配置文件，请看<code>ingress</code>目录下（关键字段，我已经给了注释），此时你应该较容易看懂，
然后使用<code>docker-compose up</code></li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-etcd-mater01 ingress<span class="token punctuation">]</span><span class="token comment"># docker-compose up</span>
Creating network <span class="token string">&quot;ingress_envoymesh&quot;</span> with the default driver
Creating ingress_mainserver_1 <span class="token punctuation">..</span>. <span class="token keyword">done</span>
Creating ingress_envoy_1      <span class="token punctuation">..</span>. <span class="token keyword">done</span>
Attaching to ingress_mainserver_1, ingress_envoy_1
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.246<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/server/server.cc:238<span class="token punctuation">]</span> initializing epoch <span class="token number">0</span> <span class="token punctuation">(</span>hot restart <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token number">11.104</span><span class="token punctuation">)</span>
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.247<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/server/server.cc:240<span class="token punctuation">]</span> statically linked extensions:
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.247<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/server/server.cc:242<span class="token punctuation">]</span>   access_loggers: envoy.file_access_log,envoy.http_grpc_access_log
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.247<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/server/server.cc:245<span class="token punctuation">]</span>   filters.http: envoy.buffer,envoy.cors,envoy.csrf,envoy.ext_authz,envoy.fault,envoy.filters.http.dynamic_forward_proxy,envoy.filters.http.grpc_http1_reverse_bridge,envoy.filters.http.header_to_metadata,envoy.filters.http.jwt_authn,envoy.filters.http.original_src,envoy.filters.http.rbac,envoy.filters.http.tap,envoy.grpc_http1_bridge,envoy.grpc_json_transcoder,envoy.grpc_web,envoy.gzip,envoy.health_check,envoy.http_dynamo_filter,envoy.ip_tagging,envoy.lua,envoy.rate_limit,envoy.router,envoy.squash
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.247<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/server/server.cc:248<span class="token punctuation">]</span>   filters.listener: envoy.listener.original_dst,envoy.listener.original_src,envoy.listener.proxy_protocol,envoy.listener.tls_inspector
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.247<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/server/server.cc:251<span class="token punctuation">]</span>   filters.network: envoy.client_ssl_auth,envoy.echo,envoy.ext_authz,envoy.filters.network.dubbo_proxy,envoy.filters.network.mysql_proxy,envoy.filters.network.rbac,envoy.filters.network.sni_cluster,envoy.filters.network.thrift_proxy,envoy.filters.network.zookeeper_proxy,envoy.http_connection_manager,envoy.mongo_proxy,envoy.ratelimit,envoy.redis_proxy,envoy.tcp_proxy
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.247<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/server/server.cc:253<span class="token punctuation">]</span>   stat_sinks: envoy.dog_statsd,envoy.metrics_service,envoy.stat_sinks.hystrix,envoy.statsd
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.247<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/server/server.cc:255<span class="token punctuation">]</span>   tracers: envoy.dynamic.ot,envoy.lightstep,envoy.tracers.datadog,envoy.tracers.opencensus,envoy.zipkin
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.247<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/server/server.cc:258<span class="token punctuation">]</span>   transport_sockets.downstream: envoy.transport_sockets.alts,envoy.transport_sockets.tap,raw_buffer,tls
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.247<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/server/server.cc:261<span class="token punctuation">]</span>   transport_sockets.upstream: envoy.transport_sockets.alts,envoy.transport_sockets.tap,raw_buffer,tls
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.247<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/server/server.cc:267<span class="token punctuation">]</span> buffer implementation: old <span class="token punctuation">(</span>libevent<span class="token punctuation">)</span>
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.254<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>warning<span class="token punctuation">]</span><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/server/server.cc:327<span class="token punctuation">]</span> No admin address given, so no admin HTTP server started.
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.256<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/server/server.cc:432<span class="token punctuation">]</span> runtime: layers:
envoy_1       <span class="token operator">|</span>   - name: base
envoy_1       <span class="token operator">|</span>     static_layer:
envoy_1       <span class="token operator">|</span>       <span class="token punctuation">{</span><span class="token punctuation">}</span>
envoy_1       <span class="token operator">|</span>   - name: admin
envoy_1       <span class="token operator">|</span>     admin_layer:
envoy_1       <span class="token operator">|</span>       <span class="token punctuation">{</span><span class="token punctuation">}</span>
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.256<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>warning<span class="token punctuation">]</span><span class="token punctuation">[</span>runtime<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/common/runtime/runtime_impl.cc:497<span class="token punctuation">]</span> Skipping unsupported runtime layer: name: <span class="token string">&quot;base&quot;</span>
envoy_1       <span class="token operator">|</span> static_layer <span class="token punctuation">{</span>
envoy_1       <span class="token operator">|</span> <span class="token punctuation">}</span>
envoy_1       <span class="token operator">|</span> 
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.256<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>config<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/server/configuration_impl.cc:61<span class="token punctuation">]</span> loading <span class="token number">0</span> static secret<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.256<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>config<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/server/configuration_impl.cc:67<span class="token punctuation">]</span> loading <span class="token number">1</span> cluster<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.261<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>upstream<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/common/upstream/cluster_manager_impl.cc:148<span class="token punctuation">]</span> cm init: all clusters initialized
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.261<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>config<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/server/configuration_impl.cc:71<span class="token punctuation">]</span> loading <span class="token number">1</span> listener<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.263<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>config<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/server/configuration_impl.cc:96<span class="token punctuation">]</span> loading tracing configuration
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.263<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>config<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/server/configuration_impl.cc:116<span class="token punctuation">]</span> loading stats sink configuration
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.263<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/server/server.cc:500<span class="token punctuation">]</span> all clusters initialized. initializing init manager
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.263<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>config<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/server/listener_manager_impl.cc:761<span class="token punctuation">]</span> all dependencies initialized. starting workers
envoy_1       <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2019</span>-12-26 <span class="token number">14</span>:28:31.264<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span>source/server/server.cc:516<span class="token punctuation">]</span> starting main dispatch loop

</code></pre></div><ol start="2"><li>进入<code>ingress_envoy_1</code>容器交互式接口，获知<code>ip</code>地址</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-etcd-mater01 egress<span class="token punctuation">]</span><span class="token comment"># docker exec -it ingress_envoy_1 /bin/sh</span>
/ <span class="token comment"># ifconfig </span>
eth0      Link encap:Ethernet  HWaddr 02:42:AC:14:00:02  
          inet addr:172.20.0.2  Bcast:172.20.255.255  Mask:255.255.0.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:32 errors:0 dropped:0 overruns:0 frame:0
          TX packets:2 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:4528 <span class="token punctuation">(</span><span class="token number">4.4</span> KiB<span class="token punctuation">)</span>  TX bytes:180 <span class="token punctuation">(</span><span class="token number">180.0</span> B<span class="token punctuation">)</span>
    
lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:0 <span class="token punctuation">(</span><span class="token number">0.0</span> B<span class="token punctuation">)</span>  TX bytes:0 <span class="token punctuation">(</span><span class="token number">0.0</span> B<span class="token punctuation">)</span>

</code></pre></div><ol start="3"><li>退出容器，使用<code>curl</code>命令，探测<code>ingress_envoy_1</code>容器的80端口；和预期一致，配置成功</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-etcd-mater01 egress<span class="token punctuation">]</span><span class="token comment"># curl 172.20.0.2</span>
This is a website server by a Go HTTP server.
    
<span class="token punctuation">[</span>root@k8s-etcd-mater01 egress<span class="token punctuation">]</span><span class="token comment"># curl 172.20.0.2/hostname</span>
Hostname: 43e46c0f245e.

</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/Aaron1989/CloudNativeNotes/edit/master/docs/istio/8.Envoy使用入门_3/index.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">1/1/2020, 2:32:10 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/CloudNativeNotes/assets/js/app.c1070463.js" defer></script><script src="/CloudNativeNotes/assets/js/2.6ea23a4f.js" defer></script><script src="/CloudNativeNotes/assets/js/50.f9be5e46.js" defer></script>
  </body>
</html>
