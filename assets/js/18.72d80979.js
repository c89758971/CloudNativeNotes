(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{241:function(t,a,s){"use strict";s.r(a);var e=s(0),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"_1-介绍"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-介绍"}},[t._v("#")]),t._v(" 1.介绍")]),t._v(" "),s("p",[t._v("准入控制器（"),s("code",[t._v("Admission Controller")]),t._v("）位于"),s("code",[t._v("API Server")]),t._v("中，在对象被持久化之前，准入控制器拦截对"),s("code",[t._v("API Server")]),t._v("的请求，一般用来做身份验证和授权。其中包含两个特殊的控制器："),s("code",[t._v("MutatingAdmissionWebhook")]),t._v("和"),s("code",[t._v("ValidatingAdmissionWebhook")])]),t._v(" "),s("h3",{attrs:{id:"_1-变更（mutating）准入控制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-变更（mutating）准入控制"}},[t._v("#")]),t._v(" 1.变更（Mutating）准入控制")]),t._v(" "),s("p",[t._v("修改请求的对象")]),t._v(" "),s("h3",{attrs:{id:"_2-验证（validating）准入控制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-验证（validating）准入控制"}},[t._v("#")]),t._v(" 2.验证（Validating）准入控制")]),t._v(" "),s("p",[t._v("验证请求的对象")]),t._v(" "),s("p",[t._v("例如我会默认开启如下的准入控制器。")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("--admission-control"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("ServiceAccount,NamespaceLifecycle,NamespaceExists,LimitRanger,ResourceQuota,MutatingAdmissionWebhook,ValidatingAdmissionWebhook\n")])])]),s("h2",{attrs:{id:"_2-常用控制器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-常用控制器"}},[t._v("#")]),t._v(" 2.常用控制器")]),t._v(" "),s("h3",{attrs:{id:"_1-alwayspullimages"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-alwayspullimages"}},[t._v("#")]),t._v(" 1.AlwaysPullImages")]),t._v(" "),s("p",[t._v("总是拉取远端镜像；")]),t._v(" "),s("p",[t._v("好处：可以避免本地镜像被恶意入侵而篡改")]),t._v(" "),s("h3",{attrs:{id:"_2-limitranger"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-limitranger"}},[t._v("#")]),t._v(" 2.LimitRanger")]),t._v(" "),s("p",[t._v("此准入控制器将确保所有资源请求不会超过"),s("code",[t._v("namespace")]),t._v("的"),s("code",[t._v("LimitRange")]),t._v("（定义Pod级别的资源限额，如cpu、mem）")]),t._v(" "),s("h3",{attrs:{id:"_3-resourcequota"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-resourcequota"}},[t._v("#")]),t._v(" 3.ResourceQuota")]),t._v(" "),s("p",[t._v("此准入控制器将观察传入请求并确保它不违反命名空间的"),s("code",[t._v("ResourceQuota")]),t._v("对象中列举的任何约束\n（定义名称空间级别的配额，如"),s("code",[t._v("pod")]),t._v("数量）")]),t._v(" "),s("h3",{attrs:{id:"_4-podsecuritypolicy"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-podsecuritypolicy"}},[t._v("#")]),t._v(" 4.PodSecurityPolicy")]),t._v(" "),s("p",[t._v("此准入控制器用于创建和修改"),s("code",[t._v("pod")]),t._v("，\n并根据请求的安全上下文和可用的"),s("code",[t._v("Pod")]),t._v("安全策略确定是否应该允许它。")]),t._v(" "),s("h2",{attrs:{id:"_3-配置参考"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-配置参考"}},[t._v("#")]),t._v(" 3.配置参考")]),t._v(" "),s("h3",{attrs:{id:"_1-limitranger"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-limitranger"}},[t._v("#")]),t._v(" 1.LimitRanger")]),t._v(" "),s("ol",[s("li",[t._v("编辑"),s("code",[t._v("limitrange-demo.yaml")]),t._v("，并"),s("code",[t._v("apply")])])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" LimitRange\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" cpu"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("limit"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("range\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myns\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("limits")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("default")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#默认上限")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cpu")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 1000m\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("defaultRequest")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cpu")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 1000m\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("min")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cpu")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 500m\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("max")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cpu")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 2000m\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("maxLimitRequestRatio")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("       "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#定义最大值是最小值的几倍，当前为4倍")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cpu")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Container\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[t._v("查看配置")])]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@centos-1 chapter10"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get LimitRange cpu-limit-range -n myns")]),t._v("\nNAME              CREATED AT\ncpu-limit-range   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2019")]),t._v("-12-10T07:38:29Z\n    \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@centos-1 chapter10"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl describe LimitRange cpu-limit-range -n myns")]),t._v("\nName:       cpu-limit-range\nNamespace:  myns\nType        Resource  Min   Max  Default Request  Default Limit  Max Limit/Request Ratio\n----        --------  ---   ---  ---------------  -------------  -----------------------\nContainer   cpu       500m  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("                "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("              "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("\n\n")])])]),s("h3",{attrs:{id:"_2-resourcequota"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-resourcequota"}},[t._v("#")]),t._v(" 2.ResourceQuota")]),t._v(" "),s("ol",[s("li",[t._v("编辑配置文件"),s("code",[t._v("resoucequota-demo.yaml")]),t._v("，并"),s("code",[t._v("apply")])])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ResourceQuota\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" quota"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("example\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myns\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hard")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pods")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"5"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("requests.cpu")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("requests.memory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 1Gi\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("limits.cpu")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("limits.memory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 2Gi\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("count/deployments.apps")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("count/deployments.extensions")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("persistentvolumeclaims")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2"')]),t._v("\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[t._v("查看配置")])]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@centos-1 chapter10"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get ResourceQuota -n myns")]),t._v("\nNAME            CREATED AT\nquota-example   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2019")]),t._v("-12-10T08:23:54Z\n    \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@centos-1 chapter10"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl describe ResourceQuota quota-example -n myns")]),t._v("\nName:                         quota-example\nNamespace:                    myns\nResource                      Used  Hard\n--------                      ----  ----\ncount/deployments.apps        "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\ncount/deployments.extensions  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\nlimits.cpu                    "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\nlimits.memory                 "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("     2Gi\npersistentvolumeclaims        "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\npods                          "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("\nrequests.cpu                  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\nrequests.memory               "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("     1Gi\n\n")])])]),s("h3",{attrs:{id:"_3-podsecuritypolicy"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-podsecuritypolicy"}},[t._v("#")]),t._v(" 3.PodSecurityPolicy")]),t._v(" "),s("p",[t._v("查看相关psp配置文件，仅供参考（已提供，未实测）")]),t._v(" "),s("h2",{attrs:{id:"_4-参考文档"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-参考文档"}},[t._v("#")]),t._v(" 4.参考文档")]),t._v(" "),s("ul",[s("li",[t._v("https://jimmysong.io/kubernetes-handbook/concepts/admission-controller.html")])])])}),[],!1,null,null,null);a.default=n.exports}}]);