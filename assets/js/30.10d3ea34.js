(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{206:function(t,s,e){"use strict";e.r(s);var a=e(0),n=Object(a.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"二进制部署高可用k8s集群"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二进制部署高可用k8s集群"}},[t._v("#")]),t._v(" 二进制部署高可用k8s集群")]),t._v(" "),e("p",[t._v("本次采用二进制文件方式部署"),e("code",[t._v("https")]),t._v("（证书有效期为10年）高可用"),e("code",[t._v("k8s")]),t._v("集群，所有涉及的配置文件和镜像均已提供，无需翻墙。\n另外，默认集群规模可支撑"),e("code",[t._v("254")]),t._v("个节点。\n如果需要调整，请自行修改"),e("code",[t._v("/etc/kubernetes/controller-manager")]),t._v("中的"),e("code",[t._v("--node-cidr-mask-size=24")]),t._v("字段")]),t._v(" "),e("ul",[e("li",[t._v("高可用设计原则")]),t._v(" "),e("li",[t._v("高可用架构")]),t._v(" "),e("li",[t._v("基础环境准备")]),t._v(" "),e("li",[t._v("Docker环境准备")]),t._v(" "),e("li",[t._v("Etcd集群部署")]),t._v(" "),e("li",[t._v("Master配置")]),t._v(" "),e("li",[t._v("Node配置")]),t._v(" "),e("li",[t._v("组件高可用扩展-apiserver")]),t._v(" "),e("li",[t._v("组件高可用扩展-controller-manager")]),t._v(" "),e("li",[t._v("组件高可用扩展-scheduler")]),t._v(" "),e("li",[t._v("CoreDns部署")]),t._v(" "),e("li",[t._v("集群高可用测试")]),t._v(" "),e("li",[t._v("证书过期时间修改和查询")])]),t._v(" "),e("h2",{attrs:{id:"_1-高可用设计原则"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-高可用设计原则"}},[t._v("#")]),t._v(" 1.高可用设计原则")]),t._v(" "),e("div",{staticClass:"language-text extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("生产环境：\n    高可用etcd集群（需定期备份），建立3、5或7个节点（奇数个节点）\n    高可用Master：\n        kube-apiserver无状态，可多实例部署：\n            借助于Haproxy、nginx或keepalived进行vip流量实现多实例冗余，用户和集群客户端通过vip访问    \n        kuber-scheduler和kuber-controller-manager：\n            只能有一个活动实例，但可以有多个备用（主备模式）\n")])])]),e("h2",{attrs:{id:"_2-高可用架构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-高可用架构"}},[t._v("#")]),t._v(" 2.高可用架构")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://github-aaron89.oss-cn-beijing.aliyuncs.com/Kubernetes/k8s-ha.png",alt:"高可用架构-1"}})]),t._v(" "),e("h2",{attrs:{id:"_3-基础环境准备"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-基础环境准备"}},[t._v("#")]),t._v(" 3.基础环境准备")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("组件")]),t._v(" "),e("th",[t._v("版本")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("kubernetes")]),t._v(" "),e("td",[t._v("v1.13.4")])]),t._v(" "),e("tr",[e("td",[t._v("etcd")]),t._v(" "),e("td",[t._v("3.3.11")])]),t._v(" "),e("tr",[e("td",[t._v("dockerce")]),t._v(" "),e("td",[t._v("19.03.5")])]),t._v(" "),e("tr",[e("td",[t._v("cni")]),t._v(" "),e("td",[t._v("v0.8.1")])]),t._v(" "),e("tr",[e("td",[t._v("OS")]),t._v(" "),e("td",[t._v("Centos6.2")])])])]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("主机名")]),t._v(" "),e("th",[t._v("ip")]),t._v(" "),e("th",[t._v("组件")]),t._v(" "),e("th",[t._v("角色")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("k8s-etcd-master01.shared")]),t._v(" "),e("td",[t._v("192.168.0.111")]),t._v(" "),e("td",[t._v("etcd/apiserver/controller-manager/scheduler")]),t._v(" "),e("td",[t._v("Master")])]),t._v(" "),e("tr",[e("td",[t._v("k8s-etcd-master02.shared")]),t._v(" "),e("td",[t._v("192.168.0.112")]),t._v(" "),e("td",[t._v("etcd/apiserver/controller-manager/scheduler")]),t._v(" "),e("td",[t._v("Master")])]),t._v(" "),e("tr",[e("td",[t._v("k8s-etcd-master03.shared")]),t._v(" "),e("td",[t._v("192.168.0.113")]),t._v(" "),e("td",[t._v("etcd/apiserver/controller-manager/scheduler")]),t._v(" "),e("td",[t._v("Master")])]),t._v(" "),e("tr",[e("td",[t._v("k8s-node01.shared")]),t._v(" "),e("td",[t._v("192.168.0.114")]),t._v(" "),e("td",[t._v("kubelet/kube-proxy")]),t._v(" "),e("td",[t._v("Node")])])])]),t._v(" "),e("p",[e("code",[t._v("hosts")]),t._v("信息和时间同步（略）:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.111   k8s-etcd-master01.shared   k8s-master01 etcd01 etcd01.ilinux.io k8s-master01.ilinux.io kubernetes-api.ilinux.io\n"),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.112   k8s-etcd-master02.shared   k8s-master02 etcd02 etcd02.ilinux.io k8s-master02.ilinux.io\n"),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.113   k8s-etcd-master03.shared   k8s-master03 etcd03 etcd03.ilinux.io k8s-master03.ilinux.io\n"),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.114   k8s-node01.shared\n")])])]),e("p",[t._v("关闭防火墙：")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("systemctl stop firewalld.service\nsystemctl stop iptables.service\nsystemctl disable firewalld.service\nsystemctl disable iptables.service\n")])])]),e("p",[t._v("关闭"),e("code",[t._v("SELINUX")]),t._v("：")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#临时关闭：")]),t._v("\nsetenforce "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n    \n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#永久关闭")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("vi")]),t._v(" /etc/selinux/config\n将SELINUX"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("enforcing改为SELINUX"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("disabled \n设置后需要重启才能生效\n")])])]),e("p",[t._v("禁用"),e("code",[t._v("swap")]),t._v("设备")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("临时禁用： swapoff  -a\n    \n永久禁用：\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v("  /etc/fstab \n注释 /dev/mapper/VolGroup-lv_swap swap 行\n")])])]),e("p",[t._v("更新"),e("code",[t._v("nss")]),t._v(" "),e("code",[t._v("curl")]),t._v(" "),e("code",[t._v("libcurl")]),t._v("（否则"),e("code",[t._v("git clone")]),t._v("会报错）")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("yum update -y nss "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" libcurl\n")])])]),e("h2",{attrs:{id:"_4-docker环境准备"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-docker环境准备"}},[t._v("#")]),t._v(" 4.Docker环境准备")]),t._v(" "),e("p",[t._v("安装步骤请参考"),e("router-link",{attrs:{to:"/Kubernetes/28.二进制部署高可用k8s集群/'http://localhost:8080/CloudNativeNotes/Kubernetes/3.使用Kubeadm部署k8s集群/#_1-环境准备'"}},[t._v("使用Kubeadm部署k8s集群")]),t._v("中的前五步即可")],1),t._v(" "),e("h2",{attrs:{id:"_5-etcd集群部署"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-etcd集群部署"}},[t._v("#")]),t._v(" 5.Etcd集群部署")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("文件")]),t._v(" "),e("th",[t._v("路径")]),t._v(" "),e("th",[t._v("说明")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("etcd.conf")]),t._v(" "),e("td",[t._v("/etc/etcd/")]),t._v(" "),e("td",[t._v("配置文件")])]),t._v(" "),e("tr",[e("td",[t._v("pki/*")]),t._v(" "),e("td",[t._v("/etc/etcd/")]),t._v(" "),e("td",[t._v("证书文件")])]),t._v(" "),e("tr",[e("td",[t._v("pki/*")]),t._v(" "),e("td",[t._v("/root/k8s-certs-generator/etcd")]),t._v(" "),e("td",[t._v("证书生成的路径（备用）")])]),t._v(" "),e("tr",[e("td",[t._v("k8s.etcd")]),t._v(" "),e("td",[t._v("/var/lib/etcd/")]),t._v(" "),e("td",[t._v("数据文件，需定期备份")])])])]),t._v(" "),e("p",[t._v("Tips：")]),t._v(" "),e("div",{staticClass:"language-text extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("下面展示如何从0->http集群->https集群的建设全过程，如果打算https一步到位，可跳过4和5两个步骤进行配置。\n")])])]),e("p",[e("code",[t._v("Master")]),t._v("端：")]),t._v(" "),e("ol",[e("li",[t._v("安装"),e("code",[t._v("3.3.11")]),t._v("的"),e("code",[t._v("etcd")])])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("yum "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" -y etcd-3.3.11-2.el7.centos\n")])])]),e("ol",{attrs:{start:"2"}},[e("li",[t._v("可以通过以下命令检查"),e("code",[t._v("install")]),t._v("是否成功")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("rpm")]),t._v(" -ql etcd\n")])])]),e("ol",{attrs:{start:"3"}},[e("li",[t._v("三台对应修改"),e("code",[t._v("/etc/etcd/etcd.conf")]),t._v("配置文件，其中"),e("code",[t._v("ETCD_LISTEN_PEER_URLS")]),t._v("\n、"),e("code",[t._v("ETCD_LISTEN_CLIENT_URLS")]),t._v("、"),e("code",[t._v("ETCD_NAME")]),t._v("、"),e("code",[t._v("ETCD_INITIAL_ADVERTISE_PEER_URLS")]),t._v("和\n"),e("code",[t._v("ETCD_ADVERTISE_CLIENT_URLS")]),t._v("需要改成自己对应的信息")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#[Member]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#ETCD_CORS=""')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ETCD_DATA_DIR")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/var/lib/etcd/default.etcd"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#ETCD_WAL_DIR=""')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ETCD_LISTEN_PEER_URLS")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://192.168.0.111:2380"')]),t._v("  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#集群内相互通信地址")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ETCD_LISTEN_CLIENT_URLS")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://192.168.0.111:2379"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#客户端访问地址")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#ETCD_MAX_SNAPSHOTS="5"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#ETCD_MAX_WALS="5"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ETCD_NAME")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"etcd01"')]),t._v("           "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#本节点etcd名")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#ETCD_SNAPSHOT_COUNT="100000"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#ETCD_HEARTBEAT_INTERVAL="100"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#ETCD_ELECTION_TIMEOUT="1000"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#ETCD_QUOTA_BACKEND_BYTES="0"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#ETCD_MAX_REQUEST_BYTES="1572864"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#ETCD_GRPC_KEEPALIVE_MIN_TIME="5s"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#ETCD_GRPC_KEEPALIVE_INTERVAL="2h0m0s"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#ETCD_GRPC_KEEPALIVE_TIMEOUT="20s"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#[Clustering]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ETCD_INITIAL_ADVERTISE_PEER_URLS")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://etcd01:2380"')]),t._v("  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#集群初始化监听在哪个地址，可用主机名")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ETCD_ADVERTISE_CLIENT_URLS")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://etcd01:2379"')]),t._v("      "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#监听在哪个地址，可用主机名 ")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#ETCD_DISCOVERY=""')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#ETCD_DISCOVERY_FALLBACK="proxy"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#ETCD_DISCOVERY_PROXY=""')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#ETCD_DISCOVERY_SRV=""')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ETCD_INITIAL_CLUSTER")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"etcd01=http://etcd01:2380,etcd02=http://etcd02:2380,etcd03=http://etcd03:2380"')]),t._v("    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#静态初始化集群")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#ETCD_INITIAL_CLUSTER_STATE="new"')]),t._v("\n")])])]),e("ol",{attrs:{start:"4"}},[e("li",[t._v("逆序依次启动"),e("code",[t._v("etcd")])])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("systemctl start etcd\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" etcd\n")])])]),e("ol",{attrs:{start:"5"}},[e("li",[t._v("此时高可用"),e("code",[t._v("etcd")]),t._v("集群已经部署完成（但是内部通信是"),e("code",[t._v("http")]),t._v("，非安全协议）")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-etcd-master02 /"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# etcdctl --endpoints='http://etcd01:2379' member list")]),t._v("\nb3504381e8ba3cb: "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("etcd02 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("peerURLs")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("http://etcd02:2380 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("clientURLs")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("http://etcd02:2379 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("isLeader")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("false\nb8b747c74aaea686: "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("etcd01 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("peerURLs")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("http://etcd01:2380 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("clientURLs")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("http://etcd01:2379 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("isLeader")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("false\nf572fdfc5cb68406: "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("etcd03 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("peerURLs")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("http://etcd03:2380 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("clientURLs")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("http://etcd03:2379 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("isLeader")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true\n")])])]),e("ol",{attrs:{start:"6"}},[e("li",[t._v("将"),e("code",[t._v("cert-generator")]),t._v("目录"),e("code",[t._v("git clone")]),t._v("到本地，然后使用"),e("code",[t._v("bash gencerts.sh etcd")]),t._v("生成"),e("code",[t._v("etcd")]),t._v("证书，默认域名是"),e("code",[t._v("ilinux.io")]),t._v("，可自行填写，然后回车")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-etcd-master01 cert-generator"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# bash gencerts.sh etcd")]),t._v("\nEnter Domain Name "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("ilinux.io"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": \n\n")])])]),e("ol",{attrs:{start:"7"}},[e("li",[t._v("证书生成并归档结果如下：")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-etcd-master01 k8s-certs-generator"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# tree etcd")]),t._v("\netcd\n├── patches\n│   └── etcd-client-cert.patch        \n└── pki\n    ├── apiserver-etcd-client.crt     "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#让apiserver作为客户端与etcd集群通信的证书     ")]),t._v("\n    ├── apiserver-etcd-client.key     "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#让apiserver作为客户端与etcd集群通信的证书")]),t._v("\n    ├── ca.crt                        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#etcd https测试功能是否成功的证书")]),t._v("\n    ├── ca.key                        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#etcd https测试功能是否成功的证书")]),t._v("\n    ├── client.crt               "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#客户端证书,apiserver也可以用这一个")]),t._v("\n    ├── client.key               "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#客户端私钥,apiserver也可以用这一个")]),t._v("\n    ├── peer.crt                 "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#etcd集群对等通信证书  ")]),t._v("\n    ├── peer.key                 "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#etcd集群对等通信私钥  ")]),t._v("\n    ├── server.crt               "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#服务端证书")]),t._v("\n    └── server.key               "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#服务端私钥")]),t._v("\n\n")])])]),e("ol",{attrs:{start:"8"}},[e("li",[t._v("证书分发至各"),e("code",[t._v("Master")]),t._v("节点的"),e("code",[t._v("/etc/etcd/")]),t._v("目录下")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" etcd\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#本机")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" -rp pki/ /etc/etcd/ -a\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#各节点")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("scp")]),t._v(" -rp pki/ etcd02:/etc/etcd/\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("scp")]),t._v(" -rp pki/ etcd03:/etc/etcd/\n")])])]),e("ol",{attrs:{start:"9"}},[e("li",[t._v("修改各"),e("code",[t._v("Master")]),t._v("节点的"),e("code",[t._v("/etc/etcd/etcd.conf")]),t._v("配置文件中的"),e("code",[t._v("Security")]),t._v("段落")])]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#[Security]")]),t._v('\nETCD_CERT_FILE="/etc/etcd/pki/server.crt"\nETCD_KEY_FILE="/etc/etcd/pki/server.key"\nETCD_CLIENT_CERT_AUTH="true"                        '),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#服务端必须验证客户端证书 ")]),t._v('\nETCD_TRUSTED_CA_FILE="/etc/etcd/pki/ca.crt"\n'),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#ETCD_AUTO_TLS="false"')]),t._v('\nETCD_PEER_CERT_FILE="/etc/etcd/pki/peer.crt"\nETCD_PEER_KEY_FILE="/etc/etcd/pki/peer.key"\nETCD_PEER_CLIENT_CERT_AUTH="true"                    '),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#集群间必须相互验证证书")]),t._v('\nETCD_PEER_TRUSTED_CA_FILE="/etc/etcd/pki/ca.crt"\n'),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#ETCD_PEER_AUTO_TLS="false"')]),t._v("\n")])])]),e("ol",{attrs:{start:"10"}},[e("li",[t._v("将第三步修改的"),e("code",[t._v("http")]),t._v("全改成"),e("code",[t._v("https")]),t._v("，"),e("code",[t._v("ETCD_DATA_DIR")]),t._v("修改成新地址，"),e("code",[t._v('ETCD_NAME="etcd03.ilinux.io"')]),t._v("修改成和"),e("code",[t._v("ca")]),t._v("域名设置时的"),e("code",[t._v("Domain Name")]),t._v("保持一致，最后修改"),e("code",[t._v('ETCD_INITIAL_CLUSTER_TOKEN="k8s-etcd-cluster"')]),t._v(",完成配置文件可参阅"),e("code",[t._v("etcd/etcd.conf")])])]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Member"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v('\nETCD_DATA_DIR="/var/lib/etcd/k8s.etcd"\nETCD_LISTEN_PEER_URLS="https'),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//192.168.0.113"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('2380"\nETCD_LISTEN_CLIENT_URLS="https'),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//192.168.0.113"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('2379"\nETCD_NAME="etcd03.ilinux.io"\n  \n'),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#[Clustering]")]),t._v('\nETCD_INITIAL_ADVERTISE_PEER_URLS="https'),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//etcd03.ilinux.io"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('2380"\nETCD_ADVERTISE_CLIENT_URLS="https'),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//etcd03.ilinux.io"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('2379"\nETCD_INITIAL_CLUSTER="etcd01.ilinux.io=https'),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//etcd01.ilinux.io"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2380")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("etcd02.ilinux.io=https"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//etcd02.ilinux.io"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2380")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("etcd03.ilinux.io=https"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//etcd03.ilinux.io"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('2380"\nETCD_INITIAL_CLUSTER_TOKEN="k8s'),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("etcd"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('cluster"\n  \n'),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#[Security]")]),t._v('\nETCD_CERT_FILE="/etc/etcd/pki/server.crt"\nETCD_KEY_FILE="/etc/etcd/pki/server.key"\nETCD_CLIENT_CERT_AUTH="true"                 '),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#服务端必须验证客户端证书")]),t._v('\nETCD_TRUSTED_CA_FILE="/etc/etcd/pki/ca.crt"\nETCD_PEER_CERT_FILE="/etc/etcd/pki/peer.crt"\nETCD_PEER_KEY_FILE="/etc/etcd/pki/peer.key"\nETCD_PEER_CLIENT_CERT_AUTH="true"             '),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#集群间必须相互验证证书")]),t._v('\nETCD_PEER_TRUSTED_CA_FILE="/etc/etcd/pki/ca.crt"\n\n')])])]),e("ol",{attrs:{start:"11"}},[e("li",[t._v("全部停止并重启"),e("code",[t._v("etcd")]),t._v("，并用之前生成功能测试的"),e("code",[t._v("ca")]),t._v("客户端证书进行访问，至此"),e("code",[t._v("etcd https")]),t._v("集群已经部署完成")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#全停止")]),t._v("\nsystemctl stop etcd\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#全启动")]),t._v("\nsystemctl start etcd\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#使用证书查看集群状态    ")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-etcd-master01 etcd"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# etcdctl --endpoints='https://etcd01.ilinux.io:2379' --cert-file=/etc/etcd/pki/client.crt --key-file=/etc/etcd/pki/client.key --ca-file=/etc/etcd/pki/ca.crt cluster-health")]),t._v("\nmember 1f22dc5568642e6f is healthy: got healthy result from https://etcd03.ilinux.io:2379\nmember 433f227ff9ad65cd is healthy: got healthy result from https://etcd02.ilinux.io:2379\nmember c4eb31a06cd36dd7 is healthy: got healthy result from https://etcd01.ilinux.io:2379\ncluster is healthy\n\n")])])]),e("h2",{attrs:{id:"_6-master配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-master配置"}},[t._v("#")]),t._v(" 6.Master配置")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("文件")]),t._v(" "),e("th",[t._v("路径")]),t._v(" "),e("th",[t._v("说明")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v(".*")]),t._v(" "),e("td",[t._v("/etc/kubernetes")]),t._v(" "),e("td",[t._v("master端实际配置文件")])]),t._v(" "),e("tr",[e("td",[t._v("auth/*")]),t._v(" "),e("td",[t._v("/etc/kubernetes")]),t._v(" "),e("td",[t._v("auth证书文件")])]),t._v(" "),e("tr",[e("td",[t._v("pki/*")]),t._v(" "),e("td",[t._v("/etc/kubernetes")]),t._v(" "),e("td",[t._v("pki证书文件")])]),t._v(" "),e("tr",[e("td",[t._v("token.csv")]),t._v(" "),e("td",[t._v("/etc/kubernetes")]),t._v(" "),e("td",[t._v("引导令牌文件")])]),t._v(" "),e("tr",[e("td",[t._v("token.csv")]),t._v(" "),e("td",[t._v("/root/k8s-certs-generator/kubernetes/k8s-master01")]),t._v(" "),e("td",[t._v("引导令牌文件(备用)")])]),t._v(" "),e("tr",[e("td",[t._v(".*")]),t._v(" "),e("td",[t._v("/root/k8s-certs-generator/kubernetes")]),t._v(" "),e("td",[t._v("证书生成的路径（备用）")])]),t._v(" "),e("tr",[e("td",[t._v(".*")]),t._v(" "),e("td",[t._v("/usr/local/kubernetes/server/bin")]),t._v(" "),e("td",[t._v("二进制启动文件")])]),t._v(" "),e("tr",[e("td",[t._v("kube-apiserver.service")]),t._v(" "),e("td",[t._v("/usr/lib/systemd/system")]),t._v(" "),e("td",[t._v("apiserver的启动配置文件")])]),t._v(" "),e("tr",[e("td",[t._v("kube-controller-manager.service")]),t._v(" "),e("td",[t._v("/usr/lib/systemd/system")]),t._v(" "),e("td",[t._v("controller-manager的启动配置文件")])]),t._v(" "),e("tr",[e("td",[t._v("kube-scheduler.service")]),t._v(" "),e("td",[t._v("/usr/lib/systemd/system")]),t._v(" "),e("td",[t._v("scheduler的启动配置文件")])]),t._v(" "),e("tr",[e("td",[t._v(".*")]),t._v(" "),e("td",[t._v("/var/run/kubernetes")]),t._v(" "),e("td",[t._v("k8s运行目录")])])])]),t._v(" "),e("ol",[e("li",[t._v("生成必要的证书和密钥，包括访问"),e("code",[t._v("etcd")]),t._v("集群时用到的客户端证书和私钥")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#生成证书")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /root/cert-generator\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#生成k8s相关证书")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-etcd-master01 k8s-certs-generator"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# bash gencerts.sh k8s")]),t._v("\nEnter Domain Name "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("ilinux.io"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(":                    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#不需要动，需要和etcd配置时保持一致")]),t._v("\nEnter Kubernetes Cluster Name "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("kubernetes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(":       "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#可自定义")]),t._v("\nEnter the IP Address "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" default namespace \n  of the Kubernetes API Server"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.96")]),t._v(".0.1"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(":        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#不需要改")]),t._v("\nEnter Master servers name"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("master01 master02 master03"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": k8s-master01 k8s-master02 k8s-master03      \n                                                  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#master名，与Domain Name拼接")]),t._v("\n\n")])])]),e("ol",{attrs:{start:"2"}},[e("li",[t._v("所需证书已经全部生成并归档")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-etcd-master01 k8s-certs-generator"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# tree kubernetes/")]),t._v("\nkubernetes/\n├── CA\n│   ├── ca.crt\n│   └── ca.key\n├── front-proxy\n│   ├── front-proxy-ca.crt\n│   ├── front-proxy-ca.key\n│   ├── front-proxy-client.crt\n│   └── front-proxy-client.key\n├── ingress\n│   ├── ingress-server.crt\n│   ├── ingress-server.key\n│   └── patches\n│       └── ingress-tls.patch\n├── k8s-master01\n│   ├── auth\n│   │   ├── admin.conf\n│   │   ├── controller-manager.conf\n│   │   └── scheduler.conf\n│   ├── pki\n│   │   ├── apiserver.crt\n│   │   ├── apiserver-etcd-client.crt\n│   │   ├── apiserver-etcd-client.key\n│   │   ├── apiserver.key\n│   │   ├── apiserver-kubelet-client.crt\n│   │   ├── apiserver-kubelet-client.key\n│   │   ├── ca.crt\n│   │   ├── ca.key\n│   │   ├── front-proxy-ca.crt\n│   │   ├── front-proxy-ca.key\n│   │   ├── front-proxy-client.crt\n│   │   ├── front-proxy-client.key\n│   │   ├── kube-controller-manager.crt\n│   │   ├── kube-controller-manager.key\n│   │   ├── kube-scheduler.crt\n│   │   ├── kube-scheduler.key\n│   │   ├── sa.key\n│   │   └── sa.pub\n│   └── token.csv\n├── k8s-master02\n│   ├── auth\n│   │   ├── admin.conf\n│   │   ├── controller-manager.conf\n│   │   └── scheduler.conf\n│   ├── pki\n│   │   ├── apiserver.crt\n│   │   ├── apiserver-etcd-client.crt\n│   │   ├── apiserver-etcd-client.key\n│   │   ├── apiserver.key\n│   │   ├── apiserver-kubelet-client.crt\n│   │   ├── apiserver-kubelet-client.key\n│   │   ├── ca.crt\n│   │   ├── ca.key\n│   │   ├── front-proxy-ca.crt\n│   │   ├── front-proxy-ca.key\n│   │   ├── front-proxy-client.crt\n│   │   ├── front-proxy-client.key\n│   │   ├── kube-controller-manager.crt\n│   │   ├── kube-controller-manager.key\n│   │   ├── kube-scheduler.crt\n│   │   ├── kube-scheduler.key\n│   │   ├── sa.key\n│   │   └── sa.pub\n│   └── token.csv\n├── k8s-master03\n│   ├── auth\n│   │   ├── admin.conf\n│   │   ├── controller-manager.conf\n│   │   └── scheduler.conf\n│   ├── pki\n│   │   ├── apiserver.crt\n│   │   ├── apiserver-etcd-client.crt\n│   │   ├── apiserver-etcd-client.key\n│   │   ├── apiserver.key\n│   │   ├── apiserver-kubelet-client.crt\n│   │   ├── apiserver-kubelet-client.key\n│   │   ├── ca.crt\n│   │   ├── ca.key\n│   │   ├── front-proxy-ca.crt\n│   │   ├── front-proxy-ca.key\n│   │   ├── front-proxy-client.crt\n│   │   ├── front-proxy-client.key\n│   │   ├── kube-controller-manager.crt\n│   │   ├── kube-controller-manager.key\n│   │   ├── kube-scheduler.crt\n│   │   ├── kube-scheduler.key\n│   │   ├── sa.key\n│   │   └── sa.pub\n│   └── token.csv\n└── kubelet\n    ├── auth\n    │   ├── bootstrap.conf\n    │   └── kube-proxy.conf\n    └── pki\n        ├── ca.crt\n        ├── kube-proxy.crt\n        └── kube-proxy.key\n\n")])])]),e("ol",{attrs:{start:"3"}},[e("li",[t._v("将证书分发至各节点")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#各节点")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /etc/kubernetes\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#本节点操作")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" -r kubernetes/k8s-master01/* /etc/kubernetes/\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#其他节点")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("scp")]),t._v(" -rp kubernetes/k8s-master02/* k8s-master02:/etc/kubernetes/\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("scp")]),t._v(" -rp kubernetes/k8s-master03/* k8s-master03:/etc/kubernetes/        \n")])])]),e("ol",{attrs:{start:"4"}},[e("li",[t._v("获取"),e("code",[t._v("v1.13.4")]),t._v("二进制"),e("code",[t._v("k8s")]),t._v("文件，解压缩至"),e("code",[t._v("/usr/local")]),t._v(",并分发至其余"),e("code",[t._v("master")]),t._v("节点一份")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#获取镜像")]),t._v("\ndocker pull registry.cn-hangzhou.aliyuncs.com/aaron89/k8s_bin:v1.13.4\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#解压二进制文件    ")]),t._v("\ndocker run --rm -d --name temp registry.cn-hangzhou.aliyuncs.com/aaron89/k8s_bin:v1.13.4 "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sleep")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("\ndocker "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" temp:/kubernetes-server-linux-amd64.tar.gz "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" xf kubernetes-server-linux-amd64.tar.gz  -C /usr/local/\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#分发二进制文件")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("scp")]),t._v(" kubernetes-server-linux-amd64.tar.gz k8s-etcd-master02.shared:~\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("scp")]),t._v(" kubernetes-server-linux-amd64.tar.gz k8s-etcd-master03.shared:~\n")])])]),e("ol",{attrs:{start:"5"}},[e("li",[t._v("将我提供的配置文件"),e("code",[t._v("cp")]),t._v("到对应路径")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#本节点")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" etc/kubernetes/* /etc/kubernetes/\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" usr/lib/systemd/system/* /usr/lib/systemd/system\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#各节点")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("scp")]),t._v(" etc/kubernetes/* k8s-master02:/etc/kubernetes/\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("scp")]),t._v(" usr/lib/systemd/system/* k8s-master02:/usr/lib/systemd/system\n    \n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("scp")]),t._v(" etc/kubernetes/* k8s-master03:/etc/kubernetes/\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("scp")]),t._v(" usr/lib/systemd/system/* k8s-master03:/usr/lib/systemd/system    \n")])])]),e("ol",{attrs:{start:"6"}},[e("li",[t._v("修改"),e("code",[t._v("apiserver")]),t._v("配置文件中的"),e("code",[t._v("KUBE_ETCD_SERVERS")]),t._v("，另外"),e("code",[t._v("config")]),t._v("文件中的日志级别是"),e("code",[t._v("0(Debug)")]),t._v("，先不动,为了测试")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("KUBE_ETCD_SERVERS")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--etcd-servers=https://etcd01.ilinux.io:2379,https://etcd02.ilinux.io:2379,https://etcd03.ilinux.io:2379"')]),t._v("\n\n")])])]),e("ol",{attrs:{start:"7"}},[e("li",[t._v("创建"),e("code",[t._v("kube")]),t._v("用户、"),e("code",[t._v("kubernetes")]),t._v("运行目录和权限")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("useradd")]),t._v(" -r kube\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /var/run/kubernetes\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("chown")]),t._v(" kube.kube /var/run/kubernetes/\n")])])]),e("ol",{attrs:{start:"8"}},[e("li",[t._v("启动"),e("code",[t._v("apiserver")]),t._v("，并查看"),e("code",[t._v("status")]),t._v("是否正常.至此"),e("code",[t._v("apiserver")]),t._v("已经成功启动，连接"),e("code",[t._v("etcd")]),t._v("集群和相关证书")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("systemctl daemon-reload\nsystemctl start kube-apiserver\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" kube-apiserver\nsystemctl status kube-apiserver\n")])])]),e("ol",{attrs:{start:"9"}},[e("li",[t._v("配置"),e("code",[t._v("kubectl")]),t._v("，并使用"),e("code",[t._v("kubectl config view")]),t._v("查看配置是否正常")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" ~/.kube\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ln")]),t._v(" -sv /usr/local/kubernetes/server/bin/kubectl /usr/bin/\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" /etc/kubernetes/auth/admin.conf ~/.kube/config\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#kubectl config view   ")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-etcd-master01 auth"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl config view")]),t._v("\napiVersion: v1\nclusters:\n- cluster:\n    certificate-authority-data: DATA+OMITTED\n    server: https://k8s-master01.ilinux.io:6443\n  name: kubernetes\ncontexts:\n- context:\n    cluster: kubernetes\n    user: k8s-admin\n  name: k8s-admin@kubernetes\ncurrent-context: k8s-admin@kubernetes\nkind: Config\npreferences: "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nusers:\n- name: k8s-admin\n  user:\n    client-certificate-data: REDACTED\n    client-key-data: REDACTED\n")])])]),e("ol",{attrs:{start:"10"}},[e("li",[t._v("使用"),e("code",[t._v("get nodes")]),t._v("命令，如果没"),e("code",[t._v("error")]),t._v("就说明一切正常！")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-etcd-master01 auth"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get nodes")]),t._v("\nNo resources found.\n\n")])])]),e("ol",{attrs:{start:"11"}},[e("li",[t._v("创建"),e("code",[t._v("ClusterRoleBinding")]),t._v("，将"),e("code",[t._v("/etc/kubernetes/token.csv")]),t._v("(引导"),e("code",[t._v("token")]),t._v(")中创建用户或者用户组（二选一即可）绑定至内建的\n允许引导令牌功能的"),e("code",[t._v("clusterrole：system:node-bootstrapper")]),t._v("上。这里我使用的是"),e("code",[t._v("system:bootstrapper")]),t._v("用户。")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# token.csv说明：用户（system:bootstrapper），组（system:bootstrappers）")]),t._v("\nb21f94.fbff38f94cfd0713,"),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"system:bootstrapper"')]),t._v(",10001,"),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"system:bootstrappers"')]),t._v("\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#授权        ")]),t._v("\nkubectl create clusterrolebinding system:bootstrapper --user"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("system:bootstrapper --clusterrole"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("system:node-bootstrapper\n")])])]),e("ol",{attrs:{start:"12"}},[e("li",[t._v("启动"),e("code",[t._v("kube-controller-manager")]),t._v("和"),e("code",[t._v("kube-scheduler")])])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#controller-manager")]),t._v("\nsystemctl start kube-controller-manager\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" kube-controller-manager\nsystemctl status kube-controller-manager\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#scheduler    ")]),t._v("\nsystemctl start kube-scheduler\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" kube-scheduler    \nsystemctl status kube-scheduler\n")])])]),e("ol",{attrs:{start:"13"}},[e("li",[t._v("此时单台"),e("code",[t._v("master")]),t._v("已经配置完毕")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-etcd-master01 kubernetes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get cs")]),t._v("\nNAME                 STATUS    MESSAGE             ERROR\nscheduler            Healthy   ok                  \ncontroller-manager   Healthy   ok                  \netcd-1               Healthy   "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"health"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"true"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("   \netcd-0               Healthy   "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"health"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"true"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("   \netcd-2               Healthy   "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"health"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"true"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("   \n\n")])])]),e("h2",{attrs:{id:"_7-node配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-node配置"}},[t._v("#")]),t._v(" 7.Node配置")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("文件")]),t._v(" "),e("th",[t._v("路径")]),t._v(" "),e("th",[t._v("说明")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v(".*")]),t._v(" "),e("td",[t._v("/etc/kubernetes")]),t._v(" "),e("td",[t._v("node端实际配置文件")])]),t._v(" "),e("tr",[e("td",[t._v("auth/*")]),t._v(" "),e("td",[t._v("/etc/kubernetes")]),t._v(" "),e("td",[t._v("auth证书文件")])]),t._v(" "),e("tr",[e("td",[t._v("pki/*")]),t._v(" "),e("td",[t._v("/etc/kubernetes")]),t._v(" "),e("td",[t._v("pki证书文件")])]),t._v(" "),e("tr",[e("td",[t._v("kubelet")]),t._v(" "),e("td",[t._v("/usr/local/kubernetes/node/bin")]),t._v(" "),e("td",[t._v("kubelet二进制启动文件")])]),t._v(" "),e("tr",[e("td",[t._v("kube-proxy")]),t._v(" "),e("td",[t._v("/usr/local/kubernetes/node/bin")]),t._v(" "),e("td",[t._v("kube-proxy二进制启动文件")])]),t._v(" "),e("tr",[e("td",[t._v("kubelet")]),t._v(" "),e("td",[t._v("/var/lib/")]),t._v(" "),e("td",[t._v("kubelet的配置文件")])]),t._v(" "),e("tr",[e("td",[t._v("kube-proxy")]),t._v(" "),e("td",[t._v("/var/lib/")]),t._v(" "),e("td",[t._v("kube-proxy的配置文件")])]),t._v(" "),e("tr",[e("td",[t._v("kubelet.service")]),t._v(" "),e("td",[t._v("/usr/lib/systemd/system")]),t._v(" "),e("td",[t._v("kubelet的service文件")])]),t._v(" "),e("tr",[e("td",[t._v("kube-proxy.service")]),t._v(" "),e("td",[t._v("/usr/lib/systemd/system")]),t._v(" "),e("td",[t._v("kube-proxy的service文件")])]),t._v(" "),e("tr",[e("td",[t._v(".*")]),t._v(" "),e("td",[t._v("/opt/cni/bin")]),t._v(" "),e("td",[t._v("cni运行文件")])]),t._v(" "),e("tr",[e("td",[t._v("ipvs.modules")]),t._v(" "),e("td",[t._v("/etc/sysconfig/modules/ipvs.modules")]),t._v(" "),e("td",[t._v("ipvs脚本")])])])]),t._v(" "),e("p",[t._v("你需要自行将环境准备环节和"),e("code",[t._v("dockerce")]),t._v("环境初始化好")]),t._v(" "),e("ol",[e("li",[t._v("准备配置文件和证书")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#将本章提供的kube-proxy和kubelet整个目录复制到/var/lib/下面")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" -rp kube-proxy/ /var/lib/\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" -rp kubelet/ /var/lib/\n        \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#将本章提供的kubernetes/目录整个复制到/etc下")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" -rp kubernetes/ /etc/  \n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#将Master端生成的kubelet证书分发至node节点的/etc/kubernetes/下     ")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" ~/k8s-certs-generator/kubernetes/kubelet/\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("scp")]),t._v(" -r * k8s-node01.shared:/etc/kubernetes/\n")])])]),e("ol",{attrs:{start:"2"}},[e("li",[t._v("下载"),e("code",[t._v("cni")]),t._v("插件，并放到"),e("code",[t._v("opt/cni/bin")]),t._v("目录下")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://github.com/containernetworking/plugins/releases/download/v0.8.1/cni-plugins-linux-amd64-v0.8.1.tgz\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p /opt/cni/bin\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" xf cni-plugins-linux-amd64-v0.8.1.tgz  -C /opt/cni/bin/\n")])])]),e("ol",{attrs:{start:"3"}},[e("li",[t._v("准备"),e("code",[t._v("kublet")]),t._v("和"),e("code",[t._v("kubeproxy")]),t._v("的"),e("code",[t._v("service")]),t._v("文件")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#将本章提供的node/unit-files/*放到/usr/lib/systemd/system目录")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("scp")]),t._v(" node/unit-files/* k8s-node01.shared:/usr/lib/systemd/system\n")])])]),e("ol",{attrs:{start:"4"}},[e("li",[t._v("创建"),e("code",[t._v("bin")]),t._v("目录，并从"),e("code",[t._v("master")]),t._v("端分发"),e("code",[t._v("kubelet")]),t._v("和"),e("code",[t._v("kubeproxy")]),t._v("的二进制文件")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p /usr/local/kubernetes/node/bin/\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#在拉取过k8s二进制代码的master节点上操作    ")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("scp")]),t._v(" /usr/local/kubernetes/server/bin/kube"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("let,-proxy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" k8s-node01.shared:/usr/local/kubernetes/node/bin/\n")])])]),e("ol",{attrs:{start:"5"}},[e("li",[t._v("启动"),e("code",[t._v("kubelet")])])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("systemctl start  kubelet\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v("  kubelet\nsystemctl status  kubelet\n")])])]),e("ol",{attrs:{start:"6"}},[e("li",[e("code",[t._v("master")]),t._v("端确认加入集群的请求")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#查询请求")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-etcd-master01 auth"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get csr")]),t._v("\nNAME                                                   AGE     REQUESTOR             CONDITION\nnode-csr-O1ThCQzmKSWv7aUvCBJLF0U2A-FJY73d3l9ui2Zdf74   5m48s   system:bootstrapper   Pending\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#签署请求")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-etcd-master01 auth"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl certificate approve node-csr-O1ThCQzmKSWv7aUvCBJLF0U2A-FJY73d3l9ui2Zdf74")]),t._v("\ncertificatesigningrequest.certificates.k8s.io/node-csr-O1ThCQzmKSWv7aUvCBJLF0U2A-FJY73d3l9ui2Zdf74 approved\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# node已经加入，但是还没ready")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-etcd-master01 auth"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get nodes")]),t._v("\nNAME                STATUS     ROLES    AGE     VERSION\nk8s-node01.shared   NotReady   "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("   2m44s   v1.13.4\n    \n")])])]),e("ol",{attrs:{start:"7"}},[e("li",[t._v("启用"),e("code",[t._v("ipvs")]),t._v("内核模块\n创建内核模块载入相关的脚本文件"),e("code",[t._v("/etc/sysconfig/modules/ipvs.modules")]),t._v("，设定自动载入的内核模块。文件内容如下：")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token shebang important"}},[t._v("#!/bin/bash")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ipvs_mods_dir")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/usr/lib/modules/'),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("uname")]),t._v(" -r"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v('/kernel/net/netfilter/ipvs"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[t._v("i")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ls")]),t._v(" $ipvs_mods_dir "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" -o "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"^[^.]*"')]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("do")]),t._v("\n    /sbin/modinfo -F filename "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$i")]),t._v("  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&>")]),t._v(" /dev/null\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$?")]),t._v(" -eq "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n        /sbin/modprobe "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$i")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fi")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("done")]),t._v("\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 赋权、运行并检查    ")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("chmod")]),t._v(" +x /etc/sysconfig/modules/ipvs.modules\n/etc/sysconfig/modules/ipvs.modules\nlsmod "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" ip_vs\n")])])]),e("ol",{attrs:{start:"8"}},[e("li",[t._v("启动"),e("code",[t._v("kube-proxy")])])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-node01 kubernetes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl  start kube-proxy")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-node01 kubernetes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl  enable kube-proxy")]),t._v("\nCreated symlink from /etc/systemd/system/multi-user.target.wants/kube-proxy.service to /usr/lib/systemd/system/kube-proxy.service.\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-node01 kubernetes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl  status kube-proxy")]),t._v("\n\n")])])]),e("ol",{attrs:{start:"9"}},[e("li",[t._v("拉取"),e("code",[t._v("flannel")]),t._v("所需镜像")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#node节点")]),t._v("\ndocker pull registry.cn-hangzhou.aliyuncs.com/aaron89/flannel:v0.11.0-amd64\t\ndocker tag registry.cn-hangzhou.aliyuncs.com/aaron89/flannel:v0.11.0-amd64\t  quay.io/coreos/flannel:v0.11.0-amd64\n\ndocker pull registry.cn-hangzhou.aliyuncs.com/aaron89/pause:3.1\ndocker tag registry.cn-hangzhou.aliyuncs.com/aaron89/pause:3.1 k8s.gcr.io/pause:3.1    \n")])])]),e("ol",{attrs:{start:"10"}},[e("li",[e("code",[t._v("master")]),t._v("端"),e("code",[t._v("apply flannel")]),t._v("插件")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml\n")])])]),e("ol",{attrs:{start:"11"}},[e("li",[t._v("此时"),e("code",[t._v("flannel")]),t._v("的"),e("code",[t._v("pod")]),t._v("已经成功运行，而且"),e("code",[t._v("node")]),t._v("的状态也已经是"),e("code",[t._v("ready")]),t._v("了")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-etcd-master01 ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get pod -n kube-system -o wide")]),t._v("\nNAME                          READY   STATUS    RESTARTS   AGE   IP              NODE                NOMINATED NODE   READINESS GATES\nkube-flannel-ds-amd64-cj8rh   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          37m   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.114   k8s-node01.shared   "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("           "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n    \n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-etcd-master01 ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get node")]),t._v("\nNAME                STATUS   ROLES    AGE   VERSION\nk8s-node01.shared   Ready    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("   93m   v1.13.4    \n")])])]),e("h2",{attrs:{id:"_8-组件高可用扩展-apiserver"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_8-组件高可用扩展-apiserver"}},[t._v("#")]),t._v(" 8.组件高可用扩展-apiserver")]),t._v(" "),e("h3",{attrs:{id:"_1-其余master节点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-其余master节点"}},[t._v("#")]),t._v(" 1.其余master节点")]),t._v(" "),e("ol",[e("li",[t._v("创建"),e("code",[t._v("kube")]),t._v("用户、"),e("code",[t._v("kubernetes")]),t._v("运行目录和权限")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("useradd")]),t._v(" -r kube\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /var/run/kubernetes\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("chown")]),t._v(" kube.kube /var/run/kubernetes/\n")])])]),e("ol",{attrs:{start:"2"}},[e("li",[t._v("启动"),e("code",[t._v("apiserver")]),t._v("，并查看"),e("code",[t._v("status")]),t._v("是否正常.至此"),e("code",[t._v("apiserver")]),t._v("已经成功启动，连接"),e("code",[t._v("etcd")]),t._v("集群和相关证书")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("systemctl daemon-reload\nsystemctl start kube-apiserver\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" kube-apiserver\nsystemctl status kube-apiserver\n")])])]),e("ol",{attrs:{start:"3"}},[e("li",[t._v("配置"),e("code",[t._v("kubectl")]),t._v("(可选)")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" ~/.kube\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ln")]),t._v(" -sv /usr/local/kubernetes/server/bin/kubectl /usr/bin/\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" /etc/kubernetes/auth/admin.conf ~/.kube/config\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#使用kubelet命令查看")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-etcd-master02 kubernetes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get node")]),t._v("\nNAME                STATUS   ROLES    AGE   VERSION\nk8s-node01.shared   Ready    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("   22h   v1.13.4\n\n")])])]),e("ol",{attrs:{start:"4"}},[e("li",[t._v("集群的高可用链接地址，需要用"),e("code",[t._v("vip")]),t._v("或者多个"),e("code",[t._v("A")]),t._v("记录进行冗余。本章暂时就通过"),e("code",[t._v("hosts")]),t._v("解析在"),e("code",[t._v("mater01")]),t._v("上。")])]),t._v(" "),e("p",[t._v("高可用集群接入地址：")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("https://kubernetes-api.ilinux.io:6443\n")])])]),e("p",[t._v("配置文件位置如下：")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#master：")]),t._v("\n/root/k8s-certs-generator/kubernetes/kubelet/auth/bootstrap.conf和kube-proxy.conf\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#node:")]),t._v("\n/etc/kubernetes/auth/bootstrap.conf和kube-proxy.conf\n")])])]),e("h2",{attrs:{id:"_9-组件高可用扩展-controller-manager"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_9-组件高可用扩展-controller-manager"}},[t._v("#")]),t._v(" 9.组件高可用扩展-controller-manager")]),t._v(" "),e("h3",{attrs:{id:"_1-其余master节点-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-其余master节点-2"}},[t._v("#")]),t._v(" 1.其余master节点")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("systemctl start kube-controller-manager\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" kube-controller-manager\nsystemctl status kube-controller-manager\n")])])]),e("h2",{attrs:{id:"_10-组件高可用扩展-scheduler"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_10-组件高可用扩展-scheduler"}},[t._v("#")]),t._v(" 10.组件高可用扩展-scheduler")]),t._v(" "),e("h3",{attrs:{id:"_1-其余master节点-3"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-其余master节点-3"}},[t._v("#")]),t._v(" 1.其余master节点")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("systemctl start kube-scheduler\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" kube-scheduler\nsystemctl status kube-scheduler\n")])])]),e("h2",{attrs:{id:"_11-coredns部署"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_11-coredns部署"}},[t._v("#")]),t._v(" 11.CoreDns部署")]),t._v(" "),e("p",[t._v("1)"),e("code",[t._v("Master01")]),t._v("上进行操作")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("docker pull registry.cn-hangzhou.aliyuncs.com/aaron89/coredns:1.6.6\ndocker tag registry.cn-hangzhou.aliyuncs.com/aaron89/coredns:1.6.6 coredns/coredns:1.6.6\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://raw.githubusercontent.com/coredns/deployment/master/kubernetes/coredns.yaml.sed\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://raw.githubusercontent.com/coredns/deployment/master/kubernetes/deploy.sh\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("bash")]),t._v(" deploy.sh -i "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.96")]),t._v(".0.10 -r "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10.96.0.0/12"')]),t._v(" -s -t coredns.yaml.sed "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" kubectl apply -f -\n")])])]),e("ol",{attrs:{start:"2"}},[e("li",[t._v("解析测试")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#初始化pod")]),t._v("\ncat"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v("EOF "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" kubectl apply -f -\napiVersion: v1\nkind: Pod\nmetadata:\n  name: busybox\n  namespace: default\nspec:\n  containers:\n  - name: busybox\n    image: busybox:1.28\n    command:\n      - "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sleep")]),t._v("\n      - "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"3600"')]),t._v("\n    imagePullPolicy: IfNotPresent\n  restartPolicy: Always\nEOF\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#测试")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-etcd-mater01 ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl exec -ti busybox -- nslookup kubernetes")]),t._v("\nServer:    "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.96")]),t._v(".0.10\nAddress "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(": "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.96")]),t._v(".0.10 kube-dns.kube-system.svc.cluster.local\n    \nName:      kubernetes\nAddress "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(": "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.96")]),t._v(".0.1 kubernetes.default.svc.cluster.local\n    \n")])])]),e("h2",{attrs:{id:"_12-集群高可用测试"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_12-集群高可用测试"}},[t._v("#")]),t._v(" 12.集群高可用测试")]),t._v(" "),e("h3",{attrs:{id:"_1-etcd高可用测试"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-etcd高可用测试"}},[t._v("#")]),t._v(" 1.Etcd高可用测试")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#现在etcd02是leader节点")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-etcd-master01 unit-files"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# etcdctl --endpoints='https://etcd01.ilinux.io:2379' --cert-file=/etc/etcd/pki/client.crt --key-file=/etc/etcd/pki/client.key --ca-file=/etc/etcd/pki/ca.crt member list")]),t._v("\n1f22dc5568642e6f: "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("etcd03.ilinux.io "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("peerURLs")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("https://etcd03.ilinux.io:2380 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("clientURLs")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("https://etcd03.ilinux.io:2379 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("isLeader")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("false\n433f227ff9ad65cd: "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("etcd02.ilinux.io "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("peerURLs")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("https://etcd02.ilinux.io:2380 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("clientURLs")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("https://etcd02.ilinux.io:2379 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("isLeader")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true\nc4eb31a06cd36dd7: "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("etcd01.ilinux.io "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("peerURLs")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("https://etcd01.ilinux.io:2380 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("clientURLs")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("https://etcd01.ilinux.io:2379 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("isLeader")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("false\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#在etcd02上关闭etcd    ")]),t._v("\nsystemctl stop etcd\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#此时已经进行重新选举etcd03成了leader")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-etcd-master01 unit-files"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# etcdctl --endpoints='https://etcd01.ilinux.io:2379' --cert-file=/etc/etcd/pki/client.crt --key-file=/etc/etcd/pki/client.key --ca-file=/etc/etcd/pki/ca.crt member list")]),t._v("\n1f22dc5568642e6f: "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("etcd03.ilinux.io "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("peerURLs")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("https://etcd03.ilinux.io:2380 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("clientURLs")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("https://etcd03.ilinux.io:2379 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("isLeader")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true\n433f227ff9ad65cd: "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("etcd02.ilinux.io "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("peerURLs")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("https://etcd02.ilinux.io:2380 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("clientURLs")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("https://etcd02.ilinux.io:2379 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("isLeader")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("false\nc4eb31a06cd36dd7: "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("etcd01.ilinux.io "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("peerURLs")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("https://etcd01.ilinux.io:2380 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("clientURLs")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("https://etcd01.ilinux.io:2379 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("isLeader")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("false\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#此时集群状态是degraded降级，且k8s集群功能正常，表示etcd集群高可用验证成功")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-etcd-master01 unit-files"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# etcdctl --endpoints='https://etcd01.ilinux.io:2379' --cert-file=/etc/etcd/pki/client.crt --key-file=/etc/etcd/pki/client.key --ca-file=/etc/etcd/pki/ca.crt cluster-health")]),t._v("\nmember 1f22dc5568642e6f is healthy: got healthy result from https://etcd03.ilinux.io:2379\nfailed to check the health of member 433f227ff9ad65cd on https://etcd02.ilinux.io:2379: Get https://etcd02.ilinux.io:2379/health: dial tcp "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.112:2379: connect: connection refused\nmember 433f227ff9ad65cd is unreachable: "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("https://etcd02.ilinux.io:2379"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" are all unreachable\nmember c4eb31a06cd36dd7 is healthy: got healthy result from https://etcd01.ilinux.io:2379\ncluster is degraded\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#[root@k8s-etcd-master01 unit-files]# kubectl get node")]),t._v("\nNAME                STATUS   ROLES    AGE   VERSION\nk8s-node01.shared   Ready    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("   22h   v1.13.4\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#最后我们回复etcd02节点，发现集群状态已经恢复成healthy")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-etcd-master01 unit-files"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# etcdctl --endpoints='https://etcd01.ilinux.io:2379' --cert-file=/etc/etcd/pki/client.crt --key-file=/etc/etcd/pki/client.key --ca-file=/etc/etcd/pki/ca.crt cluster-health")]),t._v("\nmember 1f22dc5568642e6f is healthy: got healthy result from https://etcd03.ilinux.io:2379\nmember 433f227ff9ad65cd is healthy: got healthy result from https://etcd02.ilinux.io:2379\nmember c4eb31a06cd36dd7 is healthy: got healthy result from https://etcd01.ilinux.io:2379\ncluster is healthy\n        \n")])])]),e("h3",{attrs:{id:"_2-kube-controller-manager高可用测试"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-kube-controller-manager高可用测试"}},[t._v("#")]),t._v(" 2.kube-controller-manager高可用测试")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#当前controller-manager使用的是吗master01的组件（一定要注意：这是主备模式的组件，有一个工作就行），并且探测周期为15秒")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-etcd-master02 kubernetes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get endpoints -n kube-system kube-controller-manager -o yaml")]),t._v("\napiVersion: v1\nkind: Endpoints\nmetadata:\n  annotations:\n    control-plane.alpha.kubernetes.io/leader: "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{"holderIdentity":"k8s-etcd-master01.shared_25338479-2400-11ea-ac38-001c425c73bc","leaseDurationSeconds":15,"acquireTime":"2019-12-22T09:30:00Z","renewTime":"2019-12-22T11:07:15Z","leaderTransitions":3}\'')]),t._v("\n  creationTimestamp: "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2019-12-20T13:26:28Z"')]),t._v("\n  name: kube-controller-manager\n  namespace: kube-system\n  resourceVersion: "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"35332"')]),t._v("\n  selfLink: /api/v1/namespaces/kube-system/endpoints/kube-controller-manager\n  uid: 54417b97-232c-11ea-a207-001c425c73bc\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#关闭master01的controller-manager")]),t._v("\nsystemctl stop kube-controller-manager\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#此时我们发现controller-manager已经切换至k8s-etcd-master02，且一切功能正常")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-etcd-master02 kubernetes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get endpoints -n kube-system kube-controller-manager -o yaml")]),t._v("\napiVersion: v1\nkind: Endpoints\nmetadata:\n  annotations:\n    control-plane.alpha.kubernetes.io/leader: "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{"holderIdentity":"k8s-etcd-master02.shared_f16dffb2-24a7-11ea-89b4-001c42662fdd","leaseDurationSeconds":15,"acquireTime":"2019-12-22T11:11:01Z","renewTime":"2019-12-22T11:12:27Z","leaderTransitions":4}\'')]),t._v("\n  creationTimestamp: "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2019-12-20T13:26:28Z"')]),t._v("\n  name: kube-controller-manager\n  namespace: kube-system\n  resourceVersion: "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"35880"')]),t._v("\n  selfLink: /api/v1/namespaces/kube-system/endpoints/kube-controller-manager\n  uid: 54417b97-232c-11ea-a207-001c425c73bc\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#最后我们恢复master01的controller-manager,controller-manager使用的还是k8s-etcd-master02，和预期一致，测试成功")]),t._v("\nsystemctl start kube-controller-manager    \n")])])]),e("h3",{attrs:{id:"_3-kube-scheduler高可用测试"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-kube-scheduler高可用测试"}},[t._v("#")]),t._v(" 3.kube-scheduler高可用测试")]),t._v(" "),e("p",[t._v("同上，不再单独演示")]),t._v(" "),e("h2",{attrs:{id:"_13-证书过期时间修改和查询"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_13-证书过期时间修改和查询"}},[t._v("#")]),t._v(" 13.证书过期时间修改和查询")]),t._v(" "),e("p",[t._v("最后，我要说一下kubernetes默认证书1年，本章提供证书已经改为10年，你已经不需要调整；当然也可以通过修改源码的方式，修改kubernetes默认证书时间")]),t._v(" "),e("ol",[e("li",[t._v("拉取源码")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /data "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone https://github.com/kubernetes/kubernetes.git\n\n")])])]),e("ol",{attrs:{start:"2"}},[e("li",[t._v("切换到指定版本，以"),e("code",[t._v("V1.12.3")]),t._v("为例")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" checkout -b remotes/origin/release-1.12  v1.12.3\n")])])]),e("ol",{attrs:{start:"3"}},[e("li",[t._v("安装"),e("code",[t._v("go")]),t._v("环境")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /data/soft "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://dl.google.com/go/go1.11.2.linux-amd64.tar.gz\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" zxvf go1.11.2.linux-amd64.tar.gz  -C /usr/local \n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#编辑/etc/profile文件添加如下：")]),t._v("\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#go setting")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("GOROOT")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/usr/local/go\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("GOPATH")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/usr/local/gopath\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("PATH")])]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$PATH")]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$GOROOT")]),t._v("/bin\n    \n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("source")]),t._v(" /etc/profile 生效\n    \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#验证：")]),t._v("\n\ngo version\ngo version go1.11.2 linux/amd64\n\n")])])]),e("ol",{attrs:{start:"4"}},[e("li",[t._v("修改源码：\n"),e("code",[t._v("/data/kubernetes/staging/src/k8s.io/client-go/util/cert/cert.go")])])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("112")]),t._v("  NotAfter:     time.Now"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(".Add"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("duration365d * "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(".UTC"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(",\n"),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("187")]),t._v("  NotAfter:  validFrom.Add"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("maxAge *10"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(",\n"),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("215")]),t._v("  NotAfter:  validFrom.Add"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("maxAge * "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(",\n    \n原来1年 ； * "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" 表示10年 \n    \n")])])]),e("ol",{attrs:{start:"5"}},[e("li",[t._v("编译：")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /data/kubernetes/ "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("WHAT")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("cmd/kubeadm\n")])])]),e("ol",{attrs:{start:"6"}},[e("li",[t._v("查看证书过期时间")])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /etc/kubernetes/pki\n    \nopenssl x509 -in front-proxy-client.crt   -noout -text  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" Not\n            Not Before: Nov "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("28")]),t._v(" 09:07:02 "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2018")]),t._v(" GMT\n            Not After "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" Nov "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),t._v(" 09:07:03 "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2028")]),t._v(" GMT\n    \nopenssl x509 -in apiserver.crt   -noout -text  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" Not\n            Not Before: Nov "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("28")]),t._v(" 09:07:04 "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2018")]),t._v(" GMT\n            Not After "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" Nov "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),t._v(" 09:07:04 "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2028")]),t._v(" GMT\n\n")])])])])}),[],!1,null,null,null);s.default=n.exports}}]);