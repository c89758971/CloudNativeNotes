(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{251:function(s,t,a){"use strict";a.r(t);var n=a(0),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"_1-应用场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-应用场景"}},[s._v("#")]),s._v(" 1.应用场景")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("多租户隔离（名称空间级别、Pod级别）")])]),s._v(" "),a("li",[a("p",[s._v("K8S集群概念的安全组")]),s._v(" "),a("p",[s._v("flannel本身不支持Network Policy，需要使用calico、istio等service mesh，可参考附录中的最后一篇文档进行flannel+calcio结合\nNetwork Policy 的作用对象是 Pod，也可以应用到 Namespace 和集群的 Ingress、Egress 流量。\nNetwork Policy 是作用在 L3/4 层的，即限制的是对 IP 地址和端口的访问，如果需要对应用层做访问限制需要使用如 Istio 这类 Service Mesh。")])])]),s._v(" "),a("h2",{attrs:{id:"_2-核心参数讲解"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-核心参数讲解"}},[s._v("#")]),s._v(" 2.核心参数讲解")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://github-aaron89.oss-cn-beijing.aliyuncs.com/Kubernetes/networkpolicy.png",alt:"networkploicy"}})]),s._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("Ingress（类似安全组的内外网入）：\n    能接受哪些客户端的访问（-from，ports：自己端口）\n        \negress（类似安全组的内外网出）：\n    能访问哪些目标（-to，ports：目标端口）\n    \n备注：\n    当对应区域有多条规则时，满足其一即可\n")])])]),a("h2",{attrs:{id:"_3-installing-calico-for-policy-and-flannel-for-networking"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-installing-calico-for-policy-and-flannel-for-networking"}},[s._v("#")]),s._v(" 3.Installing Calico for policy and flannel for networking")]),s._v(" "),a("p",[s._v("参考文档见附录")]),s._v(" "),a("ol",[a("li",[s._v("因为我们初始化集群配置"),a("code",[s._v("flannel")]),s._v("的时候用的是"),a("code",[s._v("10.244.0.0/16")]),s._v("，所以不需要调整"),a("code",[s._v("calico")]),s._v("的配置文件，直接下载下来，"),a("code",[s._v("apply")]),s._v("就好")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" https://docs.projectcalico.org/v3.10/manifests/canal.yaml -O\n    \nkubectl apply -f canal.yaml\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[s._v("等相关"),a("code",[s._v("pod")]),s._v("运行成功之后，我们就可以编辑网络策略进行测试")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos-1 chapter11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pod -n kube-system")]),s._v("\nNAME                                      READY   STATUS            RESTARTS   AGE\ncanal-5jp8z                               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     Running           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          22m\ncanal-85l9r                               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     Running           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          22m\ncanal-mgfzd                               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     Running           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          22m\n")])])]),a("h2",{attrs:{id:"_4-newwork-policy"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-newwork-policy"}},[s._v("#")]),s._v(" 4.Newwork Policy")]),s._v(" "),a("ol",[a("li",[s._v("帮助命令")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos-1 chapter11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl explain netpol")]),s._v("\nKIND:     NetworkPolicy\nVERSION:  networking.k8s.io/v1\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[s._v("创建两个"),a("code",[s._v("namespace")]),s._v("，并分别运行"),a("code",[s._v("pod")]),s._v("，其中"),a("code",[s._v("dev")]),s._v("运行服务端，"),a("code",[s._v("prod")]),s._v("中运行客户端进行测试")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#创建namespace")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos-1 chapter11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create ns dev")]),s._v("\nnamespace/dev created\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos-1 chapter11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create ns prod")]),s._v("\nnamespace/prod created\n    \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#部署服务端pod")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos-1 chapter11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create deployment myapp --image=ikubernetes/myapp:v1 -n dev")]),s._v("\ndeployment.apps/myapp created\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#部署客户端pod,pod.yaml，并apply")]),s._v("\nkubectl apply -f pod.yaml -n prod\n")])])]),a("ol",{attrs:{start:"3"}},[a("li",[s._v("观察"),a("code",[s._v("pod")]),s._v("情况，并进客户端的交互式接口进行测试，发现"),a("code",[s._v("pod")]),s._v("通信是成功的")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos-1 chapter11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pod -n dev -o wide")]),s._v("\nNAME                     READY   STATUS    RESTARTS   AGE     IP           NODE              NOMINATED NODE   READINESS GATES\nmyapp-5c6976696c-fhn9q   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          4m31s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".2.2   centos-3.shared   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n    \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos-1 chapter11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pod -n prod -o wide")]),s._v("\nNAME         READY   STATUS    RESTARTS   AGE   IP           NODE              NOMINATED NODE   READINESS GATES\nclient-pod   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          31s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".2.3   centos-3.shared   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n    \n    \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#测试")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos-1 chapter11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl exec -it client-pod -n prod -- /bin/sh")]),s._v("\n/ "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 10.244.2.2")]),s._v("\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".2.2 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".2.2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),s._v(" data bytes\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".2.2: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("63")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.265")]),s._v(" ms\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".2.2: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("63")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.137")]),s._v(" ms\n\n")])])]),a("ol",{attrs:{start:"4"}},[a("li",[s._v("这时候，我们编辑"),a("code",[s._v("deny-all-ingress.yaml")]),s._v("（拒绝所有入站流量，且"),a("code",[s._v("dev")]),s._v("内"),a("code",[s._v("pod")]),s._v("不能相互通信）,并"),a("code",[s._v("apply")])])]),s._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" networking.k8s.io/v1             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#dev名称空间下的所有pod，不允许相互访问也不允许被外部访问")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NetworkPolicy\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deny"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("all"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ingress\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" dev\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#没指定 就是该名称空间下所有的Pod")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  ingress:                              #补充:注释的这两行表示放行所有入站流量")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  - {}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("policyTypes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" Ingress                               "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#只控制入站流量，没具体定义，就表示一个都不放行")]),s._v("\n")])])]),a("ol",{attrs:{start:"5"}},[a("li",[s._v("查看对应的"),a("code",[s._v("netpol")]),s._v("生成情况")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos-1 chapter11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get netpol -n dev")]),s._v("\nNAME               POD-SELECTOR   AGE\ndeny-all-ingress   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("         6s\n    \n        \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos-1 chapter11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl describe netpol -n dev")]),s._v("\nName:         deny-all-ingress\nNamespace:    dev\nCreated on:   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-12-11 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":04:23 +0800 CST\nLabels:       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nAnnotations:  kubectl.kubernetes.io/last-applied-configuration:\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"apiVersion"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"networking.k8s.io/v1"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kind"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"NetworkPolicy"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"metadata"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"annotations"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"deny-all-ingress"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"namespace"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dev"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(',"spe'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nSpec:\n  PodSelector:     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Allowing the specific traffic to all pods "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" this namespace"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  Allowing ingress traffic:\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Selected pods are isolated "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" ingress connectivity"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  Allowing egress traffic:\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Selected pods are isolated "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" egress connectivity"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  Policy Types: Ingress\n\n")])])]),a("ol",{attrs:{start:"6"}},[a("li",[s._v("返回我们直接的交互式接口，测试发现，现在已经访问不到dev名称空间下面的资源了，和预期隔离配置一致\n（同理："),a("code",[s._v("dev")]),s._v("内的"),a("code",[s._v("pod")]),s._v("也不能相互访问）")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("/ "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# wget -o - -q 10.244.2.2")]),s._v("\n^C\n    \n/ "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 10.244.2.2")]),s._v("\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".2.2 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".2.2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),s._v(" data bytes\n\n")])])]),a("ol",{attrs:{start:"7"}},[a("li",[s._v("接下来我们需要开放"),a("code",[s._v("ingress")]),s._v("规则，使得他们能够访问,首先给"),a("code",[s._v("prod")]),s._v("的名称空间打标签，以便"),a("code",[s._v("network policy")]),s._v("能够用选择器选中")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos-1 chapter11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl label ns prod name=prod")]),s._v("\nnamespace/prod labeled\n    \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos-1 chapter11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  kubectl get ns --show-labels")]),s._v("\nNAME                   STATUS   AGE     LABELS\ndefault                Active   15d     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\ndev                    Active   23m     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\ningress-nginx          Active   5d23h   app.kubernetes.io/name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ingress-nginx,app.kubernetes.io/part-of"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ingress-nginx\nkube-node-lease        Active   15d     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-public            Active   15d     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system            Active   15d     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkubernetes-dashboard   Active   25h     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nprod                   Active   19m     "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("prod\n")])])]),a("ol",{attrs:{start:"8"}},[a("li",[s._v("新增"),a("code",[s._v("dev-allow-prod-ingress")]),s._v("配置文件，并"),a("code",[s._v("apply")])])]),s._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" networking.k8s.io/v1             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#dev名称空间下的所有pod，不允许相互访问也不允许被外部访问")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NetworkPolicy\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" dev"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("allow"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("prod"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ingress\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" dev\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#没指定 就是该名称空间下所有的Pod")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ingress")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespceSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prod                 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#指定prod名称空间下的pod可以进行访问")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("policyTypes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" Ingress                               "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#只控制入站流量，没具体定义，就表示一个都不放行")]),s._v("\n")])])]),a("ol",{attrs:{start:"9"}},[a("li",[s._v("观察配置")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos-1 chapter11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl describe netpol dev-allow-prod-ingress -n dev")]),s._v("\nName:         dev-allow-prod-ingress\nNamespace:    dev\nCreated on:   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-12-11 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":58:06 +0800 CST\nLabels:       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nAnnotations:  kubectl.kubernetes.io/last-applied-configuration:\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"apiVersion"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"networking.k8s.io/v1"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kind"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"NetworkPolicy"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"metadata"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"annotations"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dev-allow-prod-ingress"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"namespace"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dev"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nSpec:\n  PodSelector:     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Allowing the specific traffic to all pods "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" this namespace"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  Allowing ingress traffic:\n    To Port: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("any"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("traffic allowed to all ports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    From:\n      NamespaceSelector: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("prod\n  Allowing egress traffic:\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Selected pods are isolated "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" egress connectivity"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  Policy Types: Ingress\n\n")])])]),a("ol",{attrs:{start:"10"}},[a("li",[s._v("继续进程测试，发现此时已可以访问"),a("code",[s._v("dev")]),s._v("下的"),a("code",[s._v("pod")]),s._v("资源")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos-1 chapter11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl exec -it client-pod -n prod -- /bin/sh")]),s._v("\n/ "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 10.244.2.2")]),s._v("\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".2.2 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".2.2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),s._v(" data bytes\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".2.2: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("63")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.166")]),s._v(" ms\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".2.2: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("63")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.091")]),s._v(" ms\n\n")])])]),a("h2",{attrs:{id:"_5-参考文档"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-参考文档"}},[s._v("#")]),s._v(" 5.参考文档")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("官方：")]),s._v(" "),a("p",[s._v("https://kubernetes.io/docs/concepts/services-networking/network-policies/")])]),s._v(" "),a("li",[a("p",[s._v("jimmysong：")]),s._v(" "),a("p",[s._v("https://jimmysong.io/kubernetes-handbook/concepts/network-policy.html")])]),s._v(" "),a("li",[a("p",[s._v("Calico官网：")]),s._v(" "),a("p",[s._v("https://docs.projectcalico.org/v3.10/getting-started/kubernetes/installation/flannel")])])])])}),[],!1,null,null,null);t.default=e.exports}}]);