(window.webpackJsonp=window.webpackJsonp||[]).push([[43],{229:function(s,t,n){"use strict";n.r(t);var a=n(0),e=Object(a.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"xds-api及动态配置-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#xds-api及动态配置-2"}},[s._v("#")]),s._v(" xDS API及动态配置_2")]),s._v(" "),n("p",[s._v("基于文件系统订阅，为"),n("code",[s._v("Envoy")]),s._v("提供动态配置的最简单方法；通过本章节的学习，你可以充分了解到基于文件系统订阅的概念、配置难点、"),n("code",[s._v("EDS")]),s._v("、"),n("code",[s._v("CDS")]),s._v("使用中的实战配置，包括单应用和多应用的结合。")]),s._v(" "),n("ul",[n("li",[s._v("基于文件系统订阅的概念")]),s._v(" "),n("li",[s._v("基于文件系统订阅的配置-EDS")]),s._v(" "),n("li",[s._v("基于文件系统订阅的实战-EDS")]),s._v(" "),n("li",[s._v("基于文件系统订阅的配置-CDS")]),s._v(" "),n("li",[s._v("基于文件系统订阅的实战-CDS+STRICT_DNS")]),s._v(" "),n("li",[s._v("基于文件系统订阅的实战-CDS+EDS")])]),s._v(" "),n("h2",{attrs:{id:"_1-基于文件系统订阅的概念"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-基于文件系统订阅的概念"}},[s._v("#")]),s._v(" 1.基于文件系统订阅的概念")]),s._v(" "),n("p",[s._v("基于文件系统订阅，为"),n("code",[s._v("Envoy")]),s._v("提供动态配置的最简单方法是将其放置在"),n("code",[s._v("ConfigSource")]),s._v("中显式指定的文件路径中，使用"),n("code",[s._v("inotify")]),s._v("（Mac OS X上的"),n("code",[s._v("kqueue")]),s._v("）来监视文件的更改，并在更新时解析文件中的"),n("code",[s._v("DiscoveryResponse proto")]),s._v("，其支持：")]),s._v(" "),n("div",{staticClass:"language-text extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("protobufs，JSON，YAML和proto文本\n")])])]),n("p",[s._v("但你需要注意：")]),s._v(" "),n("ul",[n("li",[s._v("无论采用上述何种方案，文件内容自身需要编排"),n("code",[s._v("为DiscoveryResponse proto")]),s._v("响应报文的格式")]),s._v(" "),n("li",[s._v("如果发生配置更新拒绝，"),n("code",[s._v("xDS API")]),s._v("的最后一个有效配置将继续适用")]),s._v(" "),n("li",[s._v("除了统计计数器和日志以外，没有任何机制可用于文件系统订阅"),n("code",[s._v("ACK/NACK")]),s._v("更新")]),s._v(" "),n("li",[s._v("最简单的提供动态配置的方法，仅方便学习，不适合生产环境使用。其手动修改环节较多，和动态的挑战场景不符。")])]),s._v(" "),n("h2",{attrs:{id:"_2-基于文件系统订阅的配置-eds"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-基于文件系统订阅的配置-eds"}},[s._v("#")]),s._v(" 2.基于文件系统订阅的配置-EDS")]),s._v(" "),n("p",[s._v("以"),n("code",[s._v("EDS")]),s._v("为例，"),n("code",[s._v("Cluster")]),s._v("为静态定义，其各"),n("code",[s._v("Endpoint")]),s._v("通过"),n("code",[s._v("EDS")]),s._v("动态发现：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://github-aaron89.oss-cn-beijing.aliyuncs.com/Kubernetes/eds_%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E8%AE%A2%E9%98%85.png",alt:"eds_文件系统订阅"}})]),s._v(" "),n("p",[s._v("如图所示，左边是我们之前一直使用的静态方式指定的方法，右边则是通过基于文件系统订阅的方式进行动态配置的。\n你需要做的是：")]),s._v(" "),n("ul",[n("li",[s._v("指定"),n("code",[s._v("type: EDS")])]),s._v(" "),n("li",[s._v("给出"),n("code",[s._v("EDS")]),s._v("对应配置即可，这里是指定订阅的文件路径")])]),s._v(" "),n("h3",{attrs:{id:"_1-订阅的文件：-etc-envoy-eds-conf"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-订阅的文件：-etc-envoy-eds-conf"}},[s._v("#")]),s._v(" 1.订阅的文件：/etc/envoy/eds.conf")]),s._v(" "),n("p",[s._v("文件的配置需要以"),n("code",[s._v("json")]),s._v("格式给出：")]),s._v(" "),n("div",{staticClass:"language-json extra-class"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"version_info"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"resources"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"@type"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"type.googleapis.com/envoy.api.v2.ClusterLoadAssignment"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"cluster_name"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"webcluster1"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"endpoints"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"lb_endpoints"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"endpoint"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"address"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"socket_address"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"address"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"172.17.0.3"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"port_value"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"endpoint"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"address"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"socket_address"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"address"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"172.17.0.3"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"port_value"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),n("p",[s._v("你需要注意的是：")]),s._v(" "),n("ol",[n("li",[s._v("基于文件订阅的配置是基于"),n("code",[s._v("inotify")]),s._v("监听的")]),s._v(" "),n("li",[s._v("配置文件的更新 需要增加"),n("code",[s._v('"version_info": "1"')]),s._v("字段的值")])]),s._v(" "),n("h2",{attrs:{id:"_3-基于文件系统订阅的实战-eds"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-基于文件系统订阅的实战-eds"}},[s._v("#")]),s._v(" 3.基于文件系统订阅的实战-EDS")]),s._v(" "),n("ol",[n("li",[s._v("首先将"),n("code",[s._v("eds-filesystem/")]),s._v("目录下的文件"),n("code",[s._v("clone")]),s._v("到本地，然后使用"),n("code",[s._v("docker-compose up")]),s._v("命令启动。你需要注意的是：")])]),s._v(" "),n("ul",[n("li",[n("code",[s._v("envoy.yaml")]),s._v("中，"),n("code",[s._v("node")]),s._v("级别的"),n("code",[s._v("id")]),s._v("和"),n("code",[s._v("cluster")]),s._v("字段必须指定")]),s._v(" "),n("li",[s._v("不建议在"),n("code",[s._v("docker compose")]),s._v("里使用"),n("code",[s._v("volume")]),s._v("挂载的方式，否则不方便触发"),n("code",[s._v("inotify")]),s._v("机制，需要手动告知"),n("code",[s._v("envoy")]),s._v("更新配置文件")]),s._v(" "),n("li",[n("code",[s._v("eds.conf")]),s._v("只是一个配置模版，里面的"),n("code",[s._v("ip")]),s._v("是不对的，你需要稍后自己去更改，体验和测试自动更新")]),s._v(" "),n("li",[s._v("本实例采用"),n("code",[s._v("egress")]),s._v("模式，这时你应该很容易就可以发现")])]),s._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("docker-compose up\n    \n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#启动信息    ")]),s._v("\nenvoy_1       "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-12-29 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(":02:05.235"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("warning"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runtime"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("source/common/runtime/runtime_impl.cc:497"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Skipping unsupported runtime layer: name: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"base"')]),s._v("\nenvoy_1       "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" static_layer "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\nenvoy_1       "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nenvoy_1       "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" \nenvoy_1       "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-12-29 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(":02:05.235"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("info"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("source/server/configuration_impl.cc:61"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" loading "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" static secret"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nenvoy_1       "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-12-29 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(":02:05.235"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("info"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("source/server/configuration_impl.cc:67"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" loading "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" cluster"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nenvoy_1       "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-12-29 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(":02:05.236"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("info"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("upstream"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("source/common/upstream/cluster_manager_impl.cc:124"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" cm init: initializing secondary clusters\nwebserver1_1  "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Listening on http://0.0.0.0:8081\nenvoy_1       "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-12-29 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(":02:05.237"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("info"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("upstream"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("source/common/upstream/cluster_manager_impl.cc:148"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" cm init: all clusters initialized\nenvoy_1       "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-12-29 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(":02:05.237"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("info"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("source/server/configuration_impl.cc:71"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" loading "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" listener"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nenvoy_1       "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-12-29 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(":02:05.239"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("info"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("source/server/configuration_impl.cc:96"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" loading tracing configuration\nenvoy_1       "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-12-29 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(":02:05.239"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("info"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("source/server/configuration_impl.cc:116"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" loading stats sink configuration\nenvoy_1       "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-12-29 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(":02:05.239"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("info"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("main"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("source/server/server.cc:500"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" all clusters initialized. initializing init manager\nenvoy_1       "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-12-29 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(":02:05.239"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("info"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("source/server/listener_manager_impl.cc:761"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" all dependencies initialized. starting workers\nenvoy_1       "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-12-29 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(":02:05.240"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("info"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("main"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("source/server/server.cc:516"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" starting main dispatch loop\nwebserver2_1  "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Listening on http://0.0.0.0:8081    \n")])])]),n("ol",{attrs:{start:"2"}},[n("li",[s._v("接下来，我们进入"),n("code",[s._v("eds-filesystem_envoy_1")]),s._v("容器的交互式接口，通过"),n("code",[s._v("admin")]),s._v("接口查看当前"),n("code",[s._v("culsters")]),s._v("的配置信息，检查"),n("code",[s._v("eds.conf")]),s._v("的内容是否成功读取")])]),s._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-etcd-mater01 eds-filesystem"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -it eds-filesystem_envoy_1 /bin/sh")]),s._v("\n    \n/etc/envoy "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 127.0.0.1:9901/listeners")]),s._v("\nlistener_http::127.0.0.1:80\n/etc/envoy "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 127.0.0.1:9901/clusters")]),s._v("\nwebcluster1::default_priority::max_connections::1024\nwebcluster1::default_priority::max_pending_requests::1024\nwebcluster1::default_priority::max_requests::1024\nwebcluster1::default_priority::max_retries::3\nwebcluster1::high_priority::max_connections::1024\nwebcluster1::high_priority::max_pending_requests::1024\nwebcluster1::high_priority::max_requests::1024\nwebcluster1::high_priority::max_retries::3\nwebcluster1::added_via_api::false\nwebcluster1::172.17.0.3:8081::cx_active::0\nwebcluster1::172.17.0.3:8081::cx_connect_fail::0\nwebcluster1::172.17.0.3:8081::cx_total::0\nwebcluster1::172.17.0.3:8081::rq_active::0\nwebcluster1::172.17.0.3:8081::rq_error::0\nwebcluster1::172.17.0.3:8081::rq_success::0\nwebcluster1::172.17.0.3:8081::rq_timeout::0\nwebcluster1::172.17.0.3:8081::rq_total::0\nwebcluster1::172.17.0.3:8081::hostname::\nwebcluster1::172.17.0.3:8081::health_flags::healthy\nwebcluster1::172.17.0.3:8081::weight::1\nwebcluster1::172.17.0.3:8081::region::\nwebcluster1::172.17.0.3:8081::zone::\nwebcluster1::172.17.0.3:8081::sub_zone::\nwebcluster1::172.17.0.3:8081::canary::false\nwebcluster1::172.17.0.3:8081::priority::0\nwebcluster1::172.17.0.3:8081::success_rate::-1\nwebcluster1::172.17.0.3:8081::local_origin_success_rate::-1\n    \n")])])]),n("ol",{attrs:{start:"3"}},[n("li",[s._v("此时我们"),n("code",[s._v("envoy.yaml")]),s._v("中"),n("code",[s._v("cluster")]),s._v("段里的"),n("code",[s._v("type:EDS")]),s._v("配置已经生效，接下来我们要获取一个业务容器的"),n("code",[s._v("ip")]),s._v("更新进来（"),n("code",[s._v("/etc/envoy/eds.conf")]),s._v("）")])]),s._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#业务容器的ip信息")]),s._v("\neds-filesystem_webserver1_1：172.23.0.3\neds-filesystem_webserver2_1：172.23.0.4\n    \n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#首先将eds-filesystem_webserver1_1：172.23.0.3进行更新，你需要时刻记住，基于文件系统订阅的热更新是基于inotify的，我们修改好/etc/envoy/eds.conf文件后，需要触发inotify")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#文件更新")]),s._v("\n/etc/envoy "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat eds.conf ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"version_info"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1"')]),s._v(",\n  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resources"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"@type"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"type.googleapis.com/envoy.api.v2.ClusterLoadAssignment"')]),s._v(",\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster_name"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"webcluster1"')]),s._v(",\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"endpoints"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lb_endpoints"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"endpoint"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"address"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"socket_address"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n              "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"address"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"172.23.0.3"')]),s._v(",\n              "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"port_value"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8081")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    \n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#触发inotify    ")]),s._v("\n/etc/envoy "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv eds.conf eds.conf.tmp && mv eds.conf.tmp eds.conf")]),s._v("\n        \n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#检查当前配置，已经成功读取        ")]),s._v("\n/etc/envoy "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 127.0.0.1:9901/clusters")]),s._v("\nwebcluster1::default_priority::max_connections::1024\nwebcluster1::default_priority::max_pending_requests::1024\nwebcluster1::default_priority::max_requests::1024\nwebcluster1::default_priority::max_retries::3\nwebcluster1::high_priority::max_connections::1024\nwebcluster1::high_priority::max_pending_requests::1024\nwebcluster1::high_priority::max_requests::1024\nwebcluster1::high_priority::max_retries::3\nwebcluster1::added_via_api::false\nwebcluster1::172.23.0.3:8081::cx_active::0\nwebcluster1::172.23.0.3:8081::cx_connect_fail::0\nwebcluster1::172.23.0.3:8081::cx_total::0\nwebcluster1::172.23.0.3:8081::rq_active::0\nwebcluster1::172.23.0.3:8081::rq_error::0\nwebcluster1::172.23.0.3:8081::rq_success::0\nwebcluster1::172.23.0.3:8081::rq_timeout::0\nwebcluster1::172.23.0.3:8081::rq_total::0\nwebcluster1::172.23.0.3:8081::hostname::\nwebcluster1::172.23.0.3:8081::health_flags::healthy\nwebcluster1::172.23.0.3:8081::weight::1\nwebcluster1::172.23.0.3:8081::region::\nwebcluster1::172.23.0.3:8081::zone::\nwebcluster1::172.23.0.3:8081::sub_zone::\nwebcluster1::172.23.0.3:8081::canary::false\nwebcluster1::172.23.0.3:8081::priority::0\nwebcluster1::172.23.0.3:8081::success_rate::-1\nwebcluster1::172.23.0.3:8081::local_origin_success_rate::-1\n\n")])])]),n("ol",{attrs:{start:"4"}},[n("li",[s._v("最后我们把另一个业务"),n("code",[s._v("ip")]),s._v("更新进去就行了，具体操作如下所示：")])]),s._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#eds.conf")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"version_info"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10"')]),s._v(",\n  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resources"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"@type"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"type.googleapis.com/envoy.api.v2.ClusterLoadAssignment"')]),s._v(",\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster_name"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"webcluster1"')]),s._v(",\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"endpoints"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lb_endpoints"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"endpoint"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"address"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"socket_address"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n              "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"address"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"172.23.0.3"')]),s._v(",\n              "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"port_value"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8081")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"endpoint"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"address"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"socket_address"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n              "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"address"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"172.23.0.4"')]),s._v(",\n              "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"port_value"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8081")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    \n    \n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#检查管理接口，你可以发现业务2的ip也已经热加载进来了")]),s._v("\n/etc/envoy "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv eds.conf eds.conf.tmp && mv eds.conf.tmp eds.conf")]),s._v("\n/etc/envoy "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 127.0.0.1:9901/clusters")]),s._v("\nwebcluster1::default_priority::max_connections::1024\nwebcluster1::default_priority::max_pending_requests::1024\nwebcluster1::default_priority::max_requests::1024\nwebcluster1::default_priority::max_retries::3\nwebcluster1::high_priority::max_connections::1024\nwebcluster1::high_priority::max_pending_requests::1024\nwebcluster1::high_priority::max_requests::1024\nwebcluster1::high_priority::max_retries::3\nwebcluster1::added_via_api::false\nwebcluster1::172.23.0.3:8081::cx_active::0\nwebcluster1::172.23.0.3:8081::cx_connect_fail::0\nwebcluster1::172.23.0.3:8081::cx_total::3\nwebcluster1::172.23.0.3:8081::rq_active::0\nwebcluster1::172.23.0.3:8081::rq_error::0\nwebcluster1::172.23.0.3:8081::rq_success::6\nwebcluster1::172.23.0.3:8081::rq_timeout::0\nwebcluster1::172.23.0.3:8081::rq_total::6\nwebcluster1::172.23.0.3:8081::hostname::\nwebcluster1::172.23.0.3:8081::health_flags::healthy\nwebcluster1::172.23.0.3:8081::weight::1\nwebcluster1::172.23.0.3:8081::region::\nwebcluster1::172.23.0.3:8081::zone::\nwebcluster1::172.23.0.3:8081::sub_zone::\nwebcluster1::172.23.0.3:8081::canary::false\nwebcluster1::172.23.0.3:8081::priority::0\nwebcluster1::172.23.0.3:8081::success_rate::-1\nwebcluster1::172.23.0.3:8081::local_origin_success_rate::-1\nwebcluster1::172.23.0.4:8081::cx_active::0\nwebcluster1::172.23.0.4:8081::cx_connect_fail::0\nwebcluster1::172.23.0.4:8081::cx_total::0\nwebcluster1::172.23.0.4:8081::rq_active::0\nwebcluster1::172.23.0.4:8081::rq_error::0\nwebcluster1::172.23.0.4:8081::rq_success::0\nwebcluster1::172.23.0.4:8081::rq_timeout::0\nwebcluster1::172.23.0.4:8081::rq_total::0\nwebcluster1::172.23.0.4:8081::hostname::\nwebcluster1::172.23.0.4:8081::health_flags::healthy\nwebcluster1::172.23.0.4:8081::weight::1\nwebcluster1::172.23.0.4:8081::region::\nwebcluster1::172.23.0.4:8081::zone::\nwebcluster1::172.23.0.4:8081::sub_zone::\nwebcluster1::172.23.0.4:8081::canary::false\nwebcluster1::172.23.0.4:8081::priority::0\nwebcluster1::172.23.0.4:8081::success_rate::-1\nwebcluster1::172.23.0.4:8081::local_origin_success_rate::-1\n    \n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#最后我们也可以通过实际访问，来进行检验。")]),s._v("\n/etc/envoy "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 127.0.0.1/hostname")]),s._v("\nHostname: 8887eef2b2e7.\n/etc/envoy "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 127.0.0.1/hostname")]),s._v("\nHostname: 687143741fc6.\n/etc/envoy "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 127.0.0.1/hostname")]),s._v("\nHostname: 8887eef2b2e7.\n/etc/envoy "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 127.0.0.1/hostname")]),s._v("\nHostname: 687143741fc6.\n")])])]),n("p",[s._v("此时，我相信你已经对EDS基于文件系统订阅的动态配置已经有了一定的了解了。")]),s._v(" "),n("h2",{attrs:{id:"_4-基于文件系统订阅的配置-cds"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-基于文件系统订阅的配置-cds"}},[s._v("#")]),s._v(" 4.基于文件系统订阅的配置-CDS")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("编辑"),n("code",[s._v("envoy.yaml")]),s._v("，将集群配置修改为动态资源。")]),s._v(" "),n("p",[s._v("注意：dynamic_resources为顶级字段！！！")])])]),s._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("dynamic_resources:\n    cds_config:\n        path: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cds.conf"')]),s._v("\n")])])]),n("ol",{attrs:{start:"2"}},[n("li",[s._v("定义"),n("code",[s._v("cds.conf")]),s._v(" ("),n("code",[s._v("/etc/envoy/cds.conf")]),s._v(") 配置文件，配置"),n("code",[s._v("Discovery Response")]),s._v("应答配置")])]),s._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"version_info"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0"')]),s._v(",\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resources"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"@type"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"type.googleapis.com/envoy.api.v2.Cluster"')]),s._v(",\n\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"targetCluster"')]),s._v(",\n\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"connect_timeout"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.25s"')]),s._v(",\n\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lb_policy"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ROUND_ROBIN"')]),s._v(",\n\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"type"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"EDS"')]),s._v(",\n\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eds_cluster_config"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"service_name"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"webcluster1"')]),s._v(",\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eds_config"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"path"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/envoy/eds.conf"')]),s._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\t\n")])])]),n("h2",{attrs:{id:"_5-基于文件系统订阅的实战-cds-strict-dns"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-基于文件系统订阅的实战-cds-strict-dns"}},[s._v("#")]),s._v(" 5.基于文件系统订阅的实战-CDS+STRICT_DNS")]),s._v(" "),n("p",[s._v("本小节通过"),n("code",[s._v("CDS+STRICT_DNS")]),s._v("的方式，向你展示"),n("code",[s._v("CDS")]),s._v("基于文件系统订阅的配置变更自动化")]),s._v(" "),n("ol",[n("li",[s._v("首先将"),n("code",[s._v("cds-filesystem/")]),s._v("目录下的文件"),n("code",[s._v("clone")]),s._v("到本地，然后使用"),n("code",[s._v("docker-compose up")]),s._v("命令启动三个容器。你需要注意的是：")])]),s._v(" "),n("ul",[n("li",[n("code",[s._v("envoy.yaml")]),s._v("中的"),n("code",[s._v("dynamic_resources")]),s._v("段是定级字段；")]),s._v(" "),n("li",[n("code",[s._v("compose")]),s._v("文件中描述的2个业务容器的别名"),n("code",[s._v("aliases：myserver")]),s._v("，在"),n("code",[s._v("cds.conf")]),s._v("中通过"),n("code",[s._v('"type": "STRICT_DNS"')]),s._v("的方式，结合"),n("code",[s._v("socket_address")]),s._v("指定的。")])]),s._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("docker-compose up\n")])])]),n("ol",{attrs:{start:"2"}},[n("li",[s._v("进入"),n("code",[s._v("cds-filesystem_envoy_1")]),s._v("容器的交互式接口，并查看"),n("code",[s._v("cluster")]),s._v("的管理接口，发现"),n("code",[s._v("CDS+STRICT_DNS")]),s._v("的方式已经成功加载，并能获取"),n("code",[s._v("cluster")]),s._v("接口的配置")])]),s._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("/etc/envoy "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 127.0.0.1:9901/clusters")]),s._v("\nwebcluster1::default_priority::max_connections::1024\nwebcluster1::default_priority::max_pending_requests::1024\nwebcluster1::default_priority::max_requests::1024\nwebcluster1::default_priority::max_retries::3\nwebcluster1::high_priority::max_connections::1024\nwebcluster1::high_priority::max_pending_requests::1024\nwebcluster1::high_priority::max_requests::1024\nwebcluster1::high_priority::max_retries::3\nwebcluster1::added_via_api::true\nwebcluster1::172.31.0.4:8081::cx_active::0\nwebcluster1::172.31.0.4:8081::cx_connect_fail::0\nwebcluster1::172.31.0.4:8081::cx_total::0\nwebcluster1::172.31.0.4:8081::rq_active::0\nwebcluster1::172.31.0.4:8081::rq_error::0\nwebcluster1::172.31.0.4:8081::rq_success::0\nwebcluster1::172.31.0.4:8081::rq_timeout::0\nwebcluster1::172.31.0.4:8081::rq_total::0\nwebcluster1::172.31.0.4:8081::hostname::myserver\nwebcluster1::172.31.0.4:8081::health_flags::healthy\nwebcluster1::172.31.0.4:8081::weight::1\nwebcluster1::172.31.0.4:8081::region::\nwebcluster1::172.31.0.4:8081::zone::\nwebcluster1::172.31.0.4:8081::sub_zone::\nwebcluster1::172.31.0.4:8081::canary::false\nwebcluster1::172.31.0.4:8081::priority::0\nwebcluster1::172.31.0.4:8081::success_rate::-1\nwebcluster1::172.31.0.4:8081::local_origin_success_rate::-1\nwebcluster1::172.31.0.3:8081::cx_active::0\nwebcluster1::172.31.0.3:8081::cx_connect_fail::0\nwebcluster1::172.31.0.3:8081::cx_total::0\nwebcluster1::172.31.0.3:8081::rq_active::0\nwebcluster1::172.31.0.3:8081::rq_error::0\nwebcluster1::172.31.0.3:8081::rq_success::0\nwebcluster1::172.31.0.3:8081::rq_timeout::0\nwebcluster1::172.31.0.3:8081::rq_total::0\nwebcluster1::172.31.0.3:8081::hostname::myserver\nwebcluster1::172.31.0.3:8081::health_flags::healthy\nwebcluster1::172.31.0.3:8081::weight::1\nwebcluster1::172.31.0.3:8081::region::\nwebcluster1::172.31.0.3:8081::zone::\nwebcluster1::172.31.0.3:8081::sub_zone::\nwebcluster1::172.31.0.3:8081::canary::false\nwebcluster1::172.31.0.3:8081::priority::0\nwebcluster1::172.31.0.3:8081::success_rate::-1\nwebcluster1::172.31.0.3:8081::local_origin_success_rate::-1\n    \n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#访问实际业务容器")]),s._v("\n/etc/envoy "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 127.0.0.1/hostname")]),s._v("\nHostname: 76519a85b890.\n/etc/envoy "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 127.0.0.1/hostname")]),s._v("\nHostname: ce52256a9f45.\n    \n")])])]),n("h2",{attrs:{id:"_6-基于文件系统订阅的实战-cds-eds"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-基于文件系统订阅的实战-cds-eds"}},[s._v("#")]),s._v(" 6.基于文件系统订阅的实战-CDS+EDS")]),s._v(" "),n("p",[s._v("如果上面的操作你已经成功完成。那么文件已经有了，现在要做的只是让配置生效，接下来你要做的是：")]),s._v(" "),n("ol",[n("li",[s._v("将"),n("code",[s._v("cds.conf.v2")]),s._v("文件的内容覆盖"),n("code",[s._v("cds.conf")]),s._v("，并更新"),n("code",[s._v('"version_info": "0"')]),s._v("字段；")]),s._v(" "),n("li",[s._v("更新"),n("code",[s._v("eds.conf")]),s._v("文件，将2个业务容器的"),n("code",[s._v("ip")]),s._v("填写进去，同时要保证更新"),n("code",[s._v('"version_info": "0"')]),s._v("字段；")]),s._v(" "),n("li",[s._v("通过"),n("code",[s._v("mv")]),s._v("命令，触发"),n("code",[s._v("inotify")]),s._v("机制："),n("code",[s._v("cds.conf")]),s._v("和"),n("code",[s._v("eds.conf")]),s._v("；")]),s._v(" "),n("li",[s._v("最后通过"),n("code",[s._v("config_dump")]),s._v("检查配置清单，因为如果你操作正确的化，"),n("code",[s._v("cluster")]),s._v("配置和上一小节是一摸一样的，无法判断。所以我们要去看配置，确认读取的是"),n("code",[s._v("STRICT_DNS")]),s._v("还是"),n("code",[s._v("EDS")]),s._v("！！！")])]),s._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("/etc/envoy "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 127.0.0.1:9901/config_dump")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"@type"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"type.googleapis.com/envoy.admin.v2alpha.ClustersConfigDump"')]),s._v(",\n   "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"version_info"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0"')]),s._v(",\n   "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dynamic_active_clusters"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"version_info"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0"')]),s._v(",\n     "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"webcluster1"')]),s._v(",\n      "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"type"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"EDS"')]),s._v(",                  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cds配置此时读取的是EDS，测试完成")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eds_cluster_config"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n       "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eds_config"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"path"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/envoy/eds.conf"')]),s._v("\n       "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n\n")])])])])}),[],!1,null,null,null);t.default=e.exports}}]);