<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用CRD扩展Kubernetes API | CloudNativeNotes</title>
    <meta name="description" content="Vuepress blog demo">
    
    
    <link rel="preload" href="/CloudNativeNotes/assets/css/0.styles.7bebe62c.css" as="style"><link rel="preload" href="/CloudNativeNotes/assets/js/app.c1070463.js" as="script"><link rel="preload" href="/CloudNativeNotes/assets/js/2.6ea23a4f.js" as="script"><link rel="preload" href="/CloudNativeNotes/assets/js/25.f48de550.js" as="script"><link rel="prefetch" href="/CloudNativeNotes/assets/js/10.f683548e.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/11.9b2223ea.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/12.3d0adbb0.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/13.24d3d2d6.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/14.fb7baf12.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/15.eb690184.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/16.6733f10e.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/17.5cea8e35.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/18.72d80979.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/19.1d75c5a7.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/20.5d1c5bdc.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/21.0d03d3c8.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/22.781cc661.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/23.da24d4a5.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/24.64806e3e.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/26.e94508f2.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/27.13277697.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/28.daef1e27.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/29.6a2b975d.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/3.a99930e0.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/30.10d3ea34.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/31.9fb204ed.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/32.0b73c47c.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/33.e496dee3.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/34.9afa7698.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/35.1af9afd5.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/36.647a0f69.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/37.73629427.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/38.147eec58.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/39.a011e2e7.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/4.3ff2fe10.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/40.f5d50c60.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/41.12a538ad.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/42.bc7be63b.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/43.509cb678.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/44.f3cbf9dd.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/45.0c6478d7.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/46.122aa56e.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/47.78053982.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/48.abeefd62.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/49.b2619eaf.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/5.d3507002.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/50.f9be5e46.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/51.70801648.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/52.3ddd65d3.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/53.968a532f.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/6.a9535db6.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/7.b77fe9cf.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/8.2c03d1fa.js"><link rel="prefetch" href="/CloudNativeNotes/assets/js/9.836f7399.js">
    <link rel="stylesheet" href="/CloudNativeNotes/assets/css/0.styles.7bebe62c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/CloudNativeNotes/" class="home-link router-link-active"><!----> <span class="site-name">CloudNativeNotes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/CloudNativeNotes/" class="nav-link">Home</a></div><div class="nav-item"><a href="/CloudNativeNotes/Docker/1.Dockerfile使用总结/" class="nav-link">Docker</a></div><div class="nav-item"><a href="/CloudNativeNotes/Kubernetes/1.Kubernetes基础/" class="nav-link">Kubernetes</a></div><div class="nav-item"><a href="/CloudNativeNotes/istio/1.Service Mesh简介/" class="nav-link">Istio</a></div><div class="nav-item"><a href="/CloudNativeNotes/Ceph/1.简介/" class="nav-link">Ceph</a></div><div class="nav-item"><a href="/CloudNativeNotes/Prometheus/" class="nav-link">Prometheus</a></div> <a href="https://github.com/Aaron1989/CloudNativeNotes" target="_blank" rel="noopener noreferrer" class="repo-link">
    My GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/CloudNativeNotes/" class="nav-link">Home</a></div><div class="nav-item"><a href="/CloudNativeNotes/Docker/1.Dockerfile使用总结/" class="nav-link">Docker</a></div><div class="nav-item"><a href="/CloudNativeNotes/Kubernetes/1.Kubernetes基础/" class="nav-link">Kubernetes</a></div><div class="nav-item"><a href="/CloudNativeNotes/istio/1.Service Mesh简介/" class="nav-link">Istio</a></div><div class="nav-item"><a href="/CloudNativeNotes/Ceph/1.简介/" class="nav-link">Ceph</a></div><div class="nav-item"><a href="/CloudNativeNotes/Prometheus/" class="nav-link">Prometheus</a></div> <a href="https://github.com/Aaron1989/CloudNativeNotes" target="_blank" rel="noopener noreferrer" class="repo-link">
    My GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>写在最前面</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CloudNativeNotes/start/1.%E9%98%85%E8%AF%BB%E6%8C%87%E5%BC%95/" class="sidebar-link">写在最前面</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Docker篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CloudNativeNotes/Docker/1.Dockerfile%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/" class="sidebar-link">Dockerfile使用总结</a></li><li><a href="/CloudNativeNotes/Docker/2.%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93%E5%92%8C%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6/" class="sidebar-link">私有仓库和资源限制</a></li><li><a href="/CloudNativeNotes/Docker/3.Docker%20Compose%E5%9F%BA%E7%A1%80%E5%BA%94%E7%94%A8/" class="sidebar-link">Docker Compose基础应用</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Kubernetes篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CloudNativeNotes/Kubernetes/1.Kubernetes%E5%9F%BA%E7%A1%80/" class="sidebar-link">Kubernetes基础</a></li><li><a href="/CloudNativeNotes/Kubernetes/2.Kubernetes%E5%9F%BA%E7%A1%80%E5%92%8C%E9%83%A8%E7%BD%B2%E8%AF%B4%E6%98%8E/" class="sidebar-link">Kubernetes基础和部署说明</a></li><li><a href="/CloudNativeNotes/Kubernetes/3.%E4%BD%BF%E7%94%A8Kubeadm%E9%83%A8%E7%BD%B2k8s%E9%9B%86%E7%BE%A4/" class="sidebar-link">使用Kubeadm部署k8s集群</a></li><li><a href="/CloudNativeNotes/Kubernetes/4.Kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" class="sidebar-link">Kubernetes快速入门</a></li><li><a href="/CloudNativeNotes/Kubernetes/5.Pod%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E9%85%8D%E7%BD%AE%E5%9F%BA%E7%A1%80/" class="sidebar-link">Pod资源清单配置基础</a></li><li><a href="/CloudNativeNotes/Kubernetes/6.Pod%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/" class="sidebar-link">Pod资源管理</a></li><li><a href="/CloudNativeNotes/Kubernetes/7.Pod%E6%8E%A7%E5%88%B6%E5%99%A8-Deployment/" class="sidebar-link">Pod控制器-Deployment</a></li><li><a href="/CloudNativeNotes/Kubernetes/8.Pod%E6%8E%A7%E5%88%B6%E5%99%A8-DaemonSet/" class="sidebar-link">Pod控制器-DaemonSet</a></li><li><a href="/CloudNativeNotes/Kubernetes/9.Pod%E6%8E%A7%E5%88%B6%E5%99%A8-Job/" class="sidebar-link">Pod控制器-Job</a></li><li><a href="/CloudNativeNotes/Kubernetes/10.Service%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/" class="sidebar-link">Service资源管理</a></li><li><a href="/CloudNativeNotes/Kubernetes/11.Ingress%E8%B5%84%E6%BA%90/" class="sidebar-link">Ingress资源</a></li><li><a href="/CloudNativeNotes/Kubernetes/12.Volume%E5%9F%BA%E7%A1%80%E5%BA%94%E7%94%A8/" class="sidebar-link">Volume基础应用源</a></li><li><a href="/CloudNativeNotes/Kubernetes/13.ConfigMap%E8%B5%84%E6%BA%90/" class="sidebar-link">ConfigMap资源</a></li><li><a href="/CloudNativeNotes/Kubernetes/14.Secret%E8%B5%84%E6%BA%90/" class="sidebar-link">Secret资源</a></li><li><a href="/CloudNativeNotes/Kubernetes/15.StatefulSet%E8%B5%84%E6%BA%90/" class="sidebar-link">StatefulSet资源</a></li><li><a href="/CloudNativeNotes/Kubernetes/16.Kubernetes%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8/" class="sidebar-link">Kubernetes系统安全</a></li><li><a href="/CloudNativeNotes/Kubernetes/17.Dashboard/" class="sidebar-link">Dashboard</a></li><li><a href="/CloudNativeNotes/Kubernetes/18.%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6%E5%99%A8/" class="sidebar-link">准入控制器</a></li><li><a href="/CloudNativeNotes/Kubernetes/19.%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E4%BD%93%E7%B3%BB/" class="sidebar-link">网络插件体系</a></li><li><a href="/CloudNativeNotes/Kubernetes/20.Network-Policy/" class="sidebar-link">Network-Policy</a></li><li><a href="/CloudNativeNotes/Kubernetes/21.%E8%B0%83%E5%BA%A6%E5%99%A8%E4%B8%8E%E8%B0%83%E5%BA%A6%E6%9C%BA%E5%88%B6/" class="sidebar-link">调度器与调度机制</a></li><li><a href="/CloudNativeNotes/Kubernetes/22.%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6%E6%9C%BA%E5%88%B6/" class="sidebar-link">高级调度机制</a></li><li><a href="/CloudNativeNotes/Kubernetes/23.%E6%B1%A1%E7%82%B9%E5%92%8C%E5%AE%B9%E5%BF%8D%E5%BA%A6/" class="sidebar-link">污点和容忍度</a></li><li><a href="/CloudNativeNotes/Kubernetes/24.%E4%BD%BF%E7%94%A8CRD%E6%89%A9%E5%B1%95Kubernetes-API/" class="active sidebar-link">使用CRD扩展Kubernetes-API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CloudNativeNotes/Kubernetes/24.%E4%BD%BF%E7%94%A8CRD%E6%89%A9%E5%B1%95Kubernetes-API/#_1-扩展方式" class="sidebar-link">1.扩展方式</a></li><li class="sidebar-sub-header"><a href="/CloudNativeNotes/Kubernetes/24.%E4%BD%BF%E7%94%A8CRD%E6%89%A9%E5%B1%95Kubernetes-API/#_2-扩展架构图" class="sidebar-link">2.扩展架构图</a></li><li class="sidebar-sub-header"><a href="/CloudNativeNotes/Kubernetes/24.%E4%BD%BF%E7%94%A8CRD%E6%89%A9%E5%B1%95Kubernetes-API/#_3-使用crd扩展kubernetes-api" class="sidebar-link">3.使用CRD扩展Kubernetes API</a></li><li class="sidebar-sub-header"><a href="/CloudNativeNotes/Kubernetes/24.%E4%BD%BF%E7%94%A8CRD%E6%89%A9%E5%B1%95Kubernetes-API/#_4-高级主题" class="sidebar-link">4.高级主题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CloudNativeNotes/Kubernetes/24.%E4%BD%BF%E7%94%A8CRD%E6%89%A9%E5%B1%95Kubernetes-API/#_1-validation（验证）" class="sidebar-link">1.Validation（验证）</a></li><li class="sidebar-sub-header"><a href="/CloudNativeNotes/Kubernetes/24.%E4%BD%BF%E7%94%A8CRD%E6%89%A9%E5%B1%95Kubernetes-API/#_2-category（分类）" class="sidebar-link">2.Category（分类）</a></li></ul></li><li class="sidebar-sub-header"><a href="/CloudNativeNotes/Kubernetes/24.%E4%BD%BF%E7%94%A8CRD%E6%89%A9%E5%B1%95Kubernetes-API/#_5-其他高级功能demo" class="sidebar-link">5.其他高级功能demo</a></li><li class="sidebar-sub-header"><a href="/CloudNativeNotes/Kubernetes/24.%E4%BD%BF%E7%94%A8CRD%E6%89%A9%E5%B1%95Kubernetes-API/#_6-参考文档" class="sidebar-link">6.参考文档</a></li></ul></li><li><a href="/CloudNativeNotes/Kubernetes/25.HPA%E6%8E%A7%E5%88%B6%E5%99%A8/" class="sidebar-link">HPA控制器</a></li><li><a href="/CloudNativeNotes/Kubernetes/26.Helm%E5%9F%BA%E7%A1%80/" class="sidebar-link">Helm基础</a></li><li><a href="/CloudNativeNotes/Kubernetes/27.Helm%E4%BD%BF%E7%94%A8%E8%BF%9B%E9%98%B6/" class="sidebar-link">Helm使用进阶</a></li><li><a href="/CloudNativeNotes/Kubernetes/28.%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2%E9%AB%98%E5%8F%AF%E7%94%A8k8s%E9%9B%86%E7%BE%A4/" class="sidebar-link">二进制部署高可用k8s集群阶</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Istio篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CloudNativeNotes/istio/1.Service%20Mesh%E7%AE%80%E4%BB%8B/" class="sidebar-link">Service Mesh简介</a></li><li><a href="/CloudNativeNotes/istio/2.%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%92%8C%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E5%9F%BA%E7%A1%80/" class="sidebar-link">微服务和服务治理基础</a></li><li><a href="/CloudNativeNotes/istio/3.Envoy%E5%9F%BA%E7%A1%80/" class="sidebar-link">Envoy基础</a></li><li><a href="/CloudNativeNotes/istio/4.Envoy%E9%83%A8%E7%BD%B2%E7%B1%BB%E5%9E%8B/" class="sidebar-link">Envoy部署类型</a></li><li><a href="/CloudNativeNotes/istio/5.Envoy%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F/" class="sidebar-link">Envoy配置方式</a></li><li><a href="/CloudNativeNotes/istio/6.Envoy%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8_1/" class="sidebar-link">Envoy使用入门_1</a></li><li><a href="/CloudNativeNotes/istio/7.Envoy%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8_2/" class="sidebar-link">Envoy使用入门_2</a></li><li><a href="/CloudNativeNotes/istio/8.Envoy%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8_3/" class="sidebar-link">Envoy使用入门_3</a></li><li><a href="/CloudNativeNotes/istio/9.Envoy%E7%AE%A1%E7%90%86%E6%8E%A5%E5%8F%A3%E5%9F%BA%E7%A1%80%E5%BA%94%E7%94%A8/" class="sidebar-link">Envoy管理接口基础应用</a></li><li><a href="/CloudNativeNotes/istio/10.Envoy%E7%BB%BC%E5%90%88%E7%A4%BA%E4%BE%8B_FrontProxy/" class="sidebar-link">Envoy综合示例_FrontProxy</a></li><li><a href="/CloudNativeNotes/istio/11.xDS%20API%E5%8F%8A%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE_1/" class="sidebar-link">xDS API及动态配置_1</a></li><li><a href="/CloudNativeNotes/istio/12.xDS%20API%E5%8F%8A%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE_2/" class="sidebar-link">xDS API及动态配置_2</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Ceph篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CloudNativeNotes/Ceph/1.%E7%AE%80%E4%BB%8B/" class="sidebar-link">综述</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Prometheus篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CloudNativeNotes/Prometheus/" class="sidebar-link">综述</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="使用crd扩展kubernetes-api"><a href="#使用crd扩展kubernetes-api" class="header-anchor">#</a> 使用CRD扩展Kubernetes API</h1> <p>有些场景，<code>kubernetes</code>内建的资源类型往往不能满足我们的需求，如<code>redis</code>集群初始化、扩容、缩容、备份等操作（类似于<code>operator</code>）。
这时候就需要我们考虑如何去扩展<code>kubernetes的API</code>。</p> <ul><li>扩展方式</li> <li>扩展架构图</li> <li>使用CRD扩展Kubernetes API</li> <li>高级主题</li> <li>其他高级功能demo</li> <li>参考文档</li></ul> <h2 id="_1-扩展方式"><a href="#_1-扩展方式" class="header-anchor">#</a> 1.扩展方式</h2> <ul><li>修改<code>kubenetes</code>的<code>apiserver</code>源码，难度最大、版本兼容性也很困难</li> <li>自定义<code>API server</code>（<code>Custom API server</code>）并聚合到<code>API</code>中，难度较大，需要开发能力</li> <li><code>1.7</code>以下版本编写<code>TPR</code>，<code>kubernetes1.7</code>及以上版本用<code>CRD</code>，常用方式</li></ul> <h2 id="_2-扩展架构图"><a href="#_2-扩展架构图" class="header-anchor">#</a> 2.扩展架构图</h2> <p><img src="https://github-aaron89.oss-cn-beijing.aliyuncs.com/Kubernetes/CRD.png" alt="扩展架构图"></p> <p>如图所示，用户对集群的请求首先到<code>apiserver</code>内部的<code>Aggregator</code>（聚合器），然后再到实际的<code>apiserver</code>模块。
上面提到的三种扩展方式，可以在图中清晰看到</p> <p>特别注意：</p> <div class="language-text extra-class"><pre class="language-text"><code>对于三种扩展方式的访问如何分配，这是基于kube-aggregator（APIservice）进行筛选的，可以理解成路由表、
或者是nginx动静分离的效果。

</code></pre></div><h2 id="_3-使用crd扩展kubernetes-api"><a href="#_3-使用crd扩展kubernetes-api" class="header-anchor">#</a> 3.使用CRD扩展Kubernetes API</h2> <ol><li>创建自定义资源类型：编辑<code>resourcedefinition.yaml</code></li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apiextensions.k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CustomResourceDefinition
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token comment"># 名称必须符合下面的格式：&lt;plural&gt;.&lt;group&gt;</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> crontabs.stable.example.com
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># REST API使用的组名称：/apis/&lt;group&gt;/&lt;version&gt;</span>
  <span class="token key atrule">group</span><span class="token punctuation">:</span> stable.example.com
  <span class="token comment"># REST API使用的版本号：/apis/&lt;group&gt;/&lt;version&gt;</span>
  <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token comment"># 定义哪个级别的资源类型：Namespaced或Cluster</span>
  <span class="token key atrule">scope</span><span class="token punctuation">:</span> Namespaced
  <span class="token key atrule">names</span><span class="token punctuation">:</span>
    <span class="token comment"># URL中使用的复数名称: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span>
    <span class="token key atrule">plural</span><span class="token punctuation">:</span> crontabs
    <span class="token comment"># CLI中使用的单数名称</span>
    <span class="token key atrule">singular</span><span class="token punctuation">:</span> crontab
    <span class="token comment"># CamelCased格式的单数类型。在清单文件中使用</span>
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> CronTab
    <span class="token comment"># CLI中使用的资源简称</span>
    <span class="token key atrule">shortNames</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ct
</code></pre></div><ol start="2"><li><code>apply</code>配置文件</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@centos-1 chapter13<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f resourcedefinition.yaml </span>
customresourcedefinition.apiextensions.k8s.io/crontabs.stable.example.com created
</code></pre></div><ol start="3"><li>创建自定义资源的对象：<code>my-new-cron-object.yaml</code>，其中<code>kind</code>引用上面自定义的资源类型：<code>CronTab</code>，并<code>apply</code></li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> <span class="token string">&quot;stable.example.com/v1&quot;</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CronTab
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>new<span class="token punctuation">-</span>cron<span class="token punctuation">-</span>object
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">cronSpec</span><span class="token punctuation">:</span> <span class="token string">&quot;* * * * /5&quot;</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>awesome<span class="token punctuation">-</span>cron<span class="token punctuation">-</span>image

</code></pre></div><ol start="4"><li>查看自定义资源类型上的<code>pod</code>资源</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@centos-1 chapter13<span class="token punctuation">]</span><span class="token comment"># kubectl get CronTab</span>
NAME                 AGE
my-new-cron-object   23s
    
        
<span class="token punctuation">[</span>root@centos-1 chapter13<span class="token punctuation">]</span><span class="token comment"># kubectl describe CronTab my-new-cron-object</span>
Name:         my-new-cron-object
Namespace:    default
Labels:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:  kubectl.kubernetes.io/last-applied-configuration:
                <span class="token punctuation">{</span><span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;stable.example.com/v1&quot;</span>,<span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;CronTab&quot;</span>,<span class="token string">&quot;metadata&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;annotations&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;my-new-cron-object&quot;</span>,<span class="token string">&quot;namespace&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">}</span>,&quot;sp<span class="token punctuation">..</span>.
API Version:  stable.example.com/v1
Kind:         CronTab
Metadata:
  Creation Timestamp:  <span class="token number">2019</span>-12-13T09:40:26Z
  Generation:          <span class="token number">1</span>
  Resource Version:    <span class="token number">151136</span>
  Self Link:           /apis/stable.example.com/v1/namespaces/default/crontabs/my-new-cron-object
  <span class="token environment constant">UID</span><span class="token builtin class-name">:</span>                 778d9359-bdb8-4f07-a07b-8a20b95f1398
Spec:
  Cron Spec:  * * * * /5
  Image:      my-awesome-cron-image
Events:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

</code></pre></div><h2 id="_4-高级主题"><a href="#_4-高级主题" class="header-anchor">#</a> 4.高级主题</h2> <h3 id="_1-validation（验证）"><a href="#_1-validation（验证）" class="header-anchor">#</a> 1.Validation（验证）</h3> <p>功能状态： Kubernetes v1.12 beta</p> <p>可以通过 <a href="https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.0.md#schemaObject" target="_blank" rel="noopener noreferrer">OpenAPI v3 schema<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>验证自定义对象是否符合标准 。</p> <ol><li>在自定义资源类型<code>CronTab</code>中，定义<code>crontabs-crd-with-validation.yaml</code>，新增<code>Validation</code>（验证）功能</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">kind</span><span class="token punctuation">:</span> CustomResourceDefinition
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> crontabs.stable.example.com
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">group</span><span class="token punctuation">:</span> stable.example.com
  <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token key atrule">names</span><span class="token punctuation">:</span>
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> CronTab
    <span class="token key atrule">plural</span><span class="token punctuation">:</span> crontabs
    <span class="token key atrule">singular</span><span class="token punctuation">:</span> crontab
    <span class="token key atrule">shortNames</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> ct 
  <span class="token key atrule">scope</span><span class="token punctuation">:</span> Namespaced
  <span class="token key atrule">validation</span><span class="token punctuation">:</span>
    <span class="token key atrule">openAPIV3Schema</span><span class="token punctuation">:</span>
      <span class="token key atrule">properties</span><span class="token punctuation">:</span>
        <span class="token key atrule">spec</span><span class="token punctuation">:</span>
          <span class="token key atrule">properties</span><span class="token punctuation">:</span>
            <span class="token key atrule">userID</span><span class="token punctuation">:</span>
              <span class="token key atrule">type</span><span class="token punctuation">:</span> integer
              <span class="token key atrule">minimum</span><span class="token punctuation">:</span> <span class="token number">1</span>
              <span class="token key atrule">maximum</span><span class="token punctuation">:</span> <span class="token number">65535</span>
            <span class="token key atrule">groups</span><span class="token punctuation">:</span>
              <span class="token key atrule">type</span><span class="token punctuation">:</span> array
            <span class="token key atrule">email</span><span class="token punctuation">:</span>
              <span class="token key atrule">type</span><span class="token punctuation">:</span> string
            <span class="token key atrule">password</span><span class="token punctuation">:</span>
              <span class="token key atrule">type</span><span class="token punctuation">:</span> string
              <span class="token key atrule">format</span><span class="token punctuation">:</span> password
          <span class="token key atrule">required</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;userID&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;groups&quot;</span><span class="token punctuation">]</span>
</code></pre></div><ol start="2"><li>编辑<code>crontabs-with-invalid-field.yaml</code>，引用<code>kind: CronTab</code>，并设置非法<code>userID</code>，验证<code>Validation</code>（验证）功能是否<code>work</code>，并<code>apply</code></li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> stable.example.com/v1      <span class="token comment">#定义规范：  &lt;group&gt;/&lt;version&gt;</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CronTab 
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tony
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">userID</span><span class="token punctuation">:</span> <span class="token number">999999</span>
</code></pre></div><ol start="3"><li>这时候发现<code>Validation</code>（验证）已经生效，拦截了<code>pod</code>初始化和运行</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@centos-1 chapter13<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f users-with-invalid-field.yaml </span>
The CronTab <span class="token string">&quot;tony&quot;</span> is invalid: 
* spec.userID: Invalid value: <span class="token number">65535</span>: spec.userID <span class="token keyword">in</span> body should be <span class="token function">less</span> than or equal to <span class="token number">65535</span>
* spec.groups: Required value

</code></pre></div><h3 id="_2-category（分类）"><a href="#_2-category（分类）" class="header-anchor">#</a> 2.Category（分类）</h3> <p>类别是自定义资源所属的分组资源的列表（例如<code>all</code>）。您可以使用<code>kubectl get &lt;category-name&gt;</code>列出属于该类别的资源。此功能是<code>beta</code>，可用于<code>v1.10</code> 中的自定义资源。</p> <p>以下示例将<code>CustomResourceDefinition</code>添加至<code>all</code>的类别列表，并说明如何使用 <code>kubectl get all</code>输出自定义资源 。</p> <ol><li>编辑<code>resourcedefinition-with-category.yaml</code>，并<code>apply</code></li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apiextensions.k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CustomResourceDefinition
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> crontabs.stable.example.com
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">group</span><span class="token punctuation">:</span> stable.example.com
  <span class="token key atrule">versions</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">served</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">scope</span><span class="token punctuation">:</span> Namespaced
  <span class="token key atrule">names</span><span class="token punctuation">:</span>
    <span class="token key atrule">plural</span><span class="token punctuation">:</span> crontabs
    <span class="token key atrule">singular</span><span class="token punctuation">:</span> crontab
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> CronTab
    <span class="token key atrule">shortNames</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ct
    <span class="token comment"># categories is a list of grouped resources the custom resource belongs to.</span>
    <span class="token key atrule">categories</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> all

</code></pre></div><ol start="2"><li>编辑<code>my-crontab.yaml</code>，并<code>apply</code></li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> <span class="token string">&quot;stable.example.com/v1&quot;</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CronTab
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>new<span class="token punctuation">-</span>cron<span class="token punctuation">-</span>object
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">cronSpec</span><span class="token punctuation">:</span> <span class="token string">&quot;* * * * */5&quot;</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>awesome<span class="token punctuation">-</span>cron<span class="token punctuation">-</span>image
</code></pre></div><ol start="3"><li>使用<code>kubectl get all</code>，这时候就可以看到我们自定义的<code>Crontab</code>类型资源了</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@centos-1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get all</span>
NAME                         READY   STATUS    RESTARTS   AGE
pod/ngx-new-cb79d555-2c7qq   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3d

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
service/kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP   18d

NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/ngx-new   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           17d

NAME                               DESIRED   CURRENT   READY   AGE
replicaset.apps/ngx-new-cb79d555   <span class="token number">1</span>         <span class="token number">1</span>         <span class="token number">1</span>       3d4h

NAME                                            AGE
crontab.stable.example.com/my-new-cron-object   1s
</code></pre></div><h2 id="_5-其他高级功能demo"><a href="#_5-其他高级功能demo" class="header-anchor">#</a> 5.其他高级功能demo</h2> <p><a href="https://github.com/Aaron1989/CloudNativeNotes/tree/master/docs/Kubernetes/24.%E4%BD%BF%E7%94%A8CRD%E6%89%A9%E5%B1%95Kubernetes-API/%E5%85%B6%E4%BB%96%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BDdemo" target="_blank" rel="noopener noreferrer">其他高级功能demo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="_6-参考文档"><a href="#_6-参考文档" class="header-anchor">#</a> 6.参考文档</h2> <ul><li><p>官方文档：</p> <p>https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/</p></li> <li><p>jimmysong.io:</p> <p>https://jimmysong.io/kubernetes-handbook/concepts/crd.html</p></li> <li><p><a href="https://www.servicemesher.com/blog/kubernetes-crd-quick-start/" target="_blank" rel="noopener noreferrer">如何从零开始编写一个Kubernetes CRD<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://jimmysong.io/kubernetes-handbook/concepts/custom-resource.html" target="_blank" rel="noopener noreferrer">使用自定义资源扩展API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/Aaron1989/CloudNativeNotes/edit/master/docs/Kubernetes/24.使用CRD扩展Kubernetes-API/index.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">12/31/2019, 11:55:25 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/CloudNativeNotes/assets/js/app.c1070463.js" defer></script><script src="/CloudNativeNotes/assets/js/2.6ea23a4f.js" defer></script><script src="/CloudNativeNotes/assets/js/25.f48de550.js" defer></script>
  </body>
</html>
